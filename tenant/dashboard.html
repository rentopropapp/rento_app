<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Rento</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container nav-content">
            <a href="home.html"><img src="../assets/rento-logo-dark.svg" alt="Rento" class="nav-logo"></a>
            
            <ul class="nav-links">
                <li><a href="dashboard.html" class="active">Dashboard</a></li>
                <li><a href="properties.html">Properties</a></li>
                <li><a href="payments.html">Payments</a></li>
                <li><a href="profile.html">Profile</a></li>
            </ul>
            
            <div class="user-menu">
                <img src="../assets/default-avatar.png" alt="Profile" class="user-avatar" id="userAvatar" onclick="toggleDropdown()">
                <div class="dropdown-menu" id="dropdownMenu">
                    <a href="profile.html" class="dropdown-item">Profile</a>
                    <a href="#" class="dropdown-item" onclick="openAccountSwitcher()">Switch Account</a>
                    <a href="#" class="dropdown-item logout-btn" onclick="logout()">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
        <div class="mobile-nav-items">
            <a href="dashboard.html" class="mobile-nav-item active">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                </svg>
                Dashboard
            </a>
            <a href="properties.html" class="mobile-nav-item">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"/>
                </svg>
                Properties
            </a>
            <a href="payments.html" class="mobile-nav-item">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6z"/>
                </svg>
                Payments
            </a>
            <a href="profile.html" class="mobile-nav-item">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
                </svg>
                Profile
            </a>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="page-header">
            <h1 class="page-title">Tenant Dashboard</h1>
        </div>

        <!-- Current Rented Properties -->
        <div style="margin-bottom: 40px;">
            <h2 style="font-size: 1.5rem; font-weight: 600; color: var(--text-dark); margin-bottom: 20px;">My Properties</h2>
            <div id="currentProperties" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px;">
                <!-- Current rented properties will be loaded here -->
                <div class="property-card">
                    <div class="property-content">
                        <div style="text-align: center; padding: 40px 20px;">
                            <div class="loading"></div>
                            <p style="margin-top: 16px; color: var(--text-gray);">Loading your properties...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scheduled Viewings -->
        <div style="margin-top: 40px;">
            <h2 style="font-size: 1.5rem; font-weight: 600; color: var(--text-dark); margin-bottom: 20px;">Scheduled Viewings</h2>
            <div id="scheduledViewings" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px;">
                <!-- Scheduled viewings will be loaded here -->
                <div class="property-card">
                    <div class="property-content">
                        <div style="text-align: center; padding: 40px 20px;">
                            <div class="loading"></div>
                            <p style="margin-top: 16px; color: var(--text-gray);">Loading scheduled viewings...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div style="margin-top: 40px;">
            <h2 style="font-size: 1.5rem; font-weight: 600; color: var(--text-dark); margin-bottom: 20px;">Quick Actions</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <button class="cta-button" onclick="window.location.href='properties.html'" style="padding: 20px; font-size: 1rem;">
                    Browse Properties
                </button>
                <button class="cta-button" onclick="window.location.href='payments.html'" style="padding: 20px; font-size: 1rem;">
                    Payment History
                </button>
            </div>
        </div>
    </div>

    <!-- User Search Request Modal -->
    <div id="searchRequestModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Submit Search Request</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            
            <form id="searchRequestForm">
                <div class="form-group">
                    <label for="propertyType" class="form-label">Property Type</label>
                    <select id="propertyType" class="form-select" required>
                        <option value="">Select type</option>
                        <option value="apartment">Apartment</option>
                        <option value="house">House</option>
                        <option value="studio">Studio</option>
                        <option value="commercial">Commercial</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="location" class="form-label">Preferred Location</label>
                    <input type="text" id="location" class="form-input" required>
                </div>

                <div class="form-group">
                    <label for="minPrice" class="form-label">Minimum Price</label>
                    <input type="number" id="minPrice" class="form-input" min="0" required>
                </div>

                <div class="form-group">
                    <label for="maxPrice" class="form-label">Maximum Price</label>
                    <input type="number" id="maxPrice" class="form-input" min="0" required>
                </div>

                <div class="form-group">
                    <label for="additionalInfo" class="form-label">Additional Requirements</label>
                    <textarea id="additionalInfo" class="form-textarea" rows="3" placeholder="Any specific requirements or preferences..."></textarea>
                </div>

                <button type="submit" class="form-button">
                    <span class="button-text">Submit Request</span>
                    <span class="loading hidden">Submitting...</span>
                </button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/auth.js"></script>
    <script>
        let currentUser = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                currentUser = AuthManager.getCurrentUser();
                if (!currentUser) {
                    // Create a mock user for testing
                    currentUser = {
                        id: 'test-tenant-123',
                        name: 'John Tenant',
                        email: 'john.tenant@example.com',
                        role: 'tenant',
                        profile_photo_url: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face&auto=format&q=80'
                    };
                }

                // Update user avatar with profile photo or initials
                updateUserAvatar(currentUser);

                // Load data - always load mock data for demonstration
                loadCurrentProperties();
                loadScheduledViewings();

            } catch (error) {
                console.error('Error initializing dashboard:', error);
                // Still load mock data even if there's an error
                loadMockProperties();
                loadMockScheduledViewings();
            }
        });

        // Update avatar when user switches accounts (listen for storage changes)
        window.addEventListener('storage', function(e) {
            if (e.key === 'user') {
                const newUser = e.newValue ? JSON.parse(e.newValue) : null;
                if (newUser) {
                    currentUser = newUser;
                    updateUserAvatar(currentUser);
                }
            }
        });

        async function loadCurrentProperties() {
            try {
                // Try to load from database first
                const tenantData = await DatabaseManager.getTenants({ user_id: currentUser.id, status: 'active' });
                
                if (tenantData && tenantData.length > 0) {
                    displayRealProperties(tenantData);
                } else {
                    // Fallback to mock data for demonstration
                    loadMockPropertiesWithRatings();
                }
            } catch (error) {
                console.log('Database load failed, using mock data:', error);
                loadMockPropertiesWithRatings();
            }
        }

        function loadMockProperties() {
            const mockProperties = [
                {
                    property_id: 'demo1',
                    property_name: 'Modern Downtown Apartment',
                    location: 'Downtown, City Center',
                    price: 1500,
                    photos_urls: ['https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?w=400'],
                    lease_start_date: '2024-01-01',
                    lease_end_date: '2024-12-31',
                    complaints: 2,
                    notices: 3,
                    expenses: 567.85
                },
                {
                    property_id: 'demo2',
                    property_name: 'Cozy Studio Loft',
                    location: 'Midtown, Arts District',
                    price: 1200,
                    photos_urls: ['https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?w=400'],
                    lease_start_date: '2023-06-15',
                    lease_end_date: '2025-06-14',
                    complaints: 0,
                    notices: 1,
                    expenses: 234.50
                },
                {
                    property_id: 'demo3',
                    property_name: 'Suburban Family Home',
                    location: 'Oak Hills, Family Neighborhood',
                    price: 2200,
                    photos_urls: ['https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=400'],
                    lease_start_date: '2023-09-01',
                    lease_end_date: '2025-08-31',
                    complaints: 1,
                    notices: 2,
                    expenses: 1205.30
                },
                {
                    property_id: 'demo4',
                    property_name: 'Luxury Penthouse Suite',
                    location: 'Upper East Side, Manhattan',
                    price: 3500,
                    photos_urls: ['https://images.unsplash.com/photo-1512917774080-9991f1c4c750?w=400'],
                    lease_start_date: '2024-03-01',
                    lease_end_date: '2025-02-28',
                    complaints: 0,
                    notices: 0,
                    expenses: 890.20
                },
                {
                    property_id: 'demo5',
                    property_name: 'Waterfront Condo',
                    location: 'Marina Bay, Waterfront District',
                    price: 2800,
                    photos_urls: ['https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=400'],
                    lease_start_date: '2024-05-15',
                    lease_end_date: '2025-05-14',
                    complaints: 1,
                    notices: 4,
                    expenses: 425.75
                }
            ];

            const container = document.getElementById('currentProperties');
            container.innerHTML = mockProperties.map(property => `
                <div class="property-card" onclick="openPropertyManagement('${property.property_id}')" style="cursor: pointer;">
                    <div class="property-image" style="background-image: url('${property.photos_urls[0]}'); height: 200px; background-size: cover; background-position: center; position: relative;">
                        <div style="position: absolute; top: 12px; right: 12px; background: var(--primary-color); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                            RENTING
                        </div>
                    </div>
                    <div class="property-content">
                        <div class="property-title">${property.property_name}</div>
                        <div class="property-location">📍 ${property.location}</div>
                        <div class="property-price">${formatCurrency(property.price)}/month</div>
                        
                        <div style="margin: 12px 0; font-size: 14px; color: var(--text-gray);">
                            <div><strong>Lease Start:</strong> ${formatDate(property.lease_start_date)}</div>
                            <div><strong>Lease End:</strong> ${formatDate(property.lease_end_date)}</div>
                        </div>
                        
                        <!-- Star Rating Section -->
                        <div style="margin: 16px 0; padding: 12px; background: rgba(8, 150, 126, 0.1); border-radius: 8px;">
                            <div style="font-size: 14px; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">Rate this property</div>
                            <div class="star-rating" data-property-id="${property.property_id}" data-current-rating="${property.user_rating || 0}">
                                ${[1, 2, 3, 4, 5].map(star => `
                                    <span class="star" data-star="${star}" onclick="rateProperty('${property.property_id}', ${star})" style="cursor: pointer; font-size: 20px; color: ${star <= (property.user_rating || 0) ? '#FFD700' : '#E5E7EB'}; margin-right: 4px;">★</span>
                                `).join('')}
                                <span style="margin-left: 8px; font-size: 12px; color: var(--text-gray);">
                                    ${property.user_rating ? `Your rating: ${property.user_rating}/5` : 'Click to rate'}
                                </span>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 12px; margin-top: 16px;">
                            <div style="flex: 1; text-align: center; padding: 8px; background: ${property.complaints > 0 ? 'rgba(220, 38, 127, 0.1)' : 'rgba(8, 150, 126, 0.1)'}; border-radius: 6px;">
                                <div style="font-size: 12px; color: var(--text-gray);">Complaints</div>
                                <div style="font-weight: 600; color: ${property.complaints > 0 ? '#dc267f' : 'var(--primary-color)'};">Manage (${property.complaints})</div>
                            </div>
                            <div style="flex: 1; text-align: center; padding: 8px; background: ${property.notices > 0 ? 'rgba(59, 130, 246, 0.1)' : 'rgba(8, 150, 126, 0.1)'}; border-radius: 6px;">
                                <div style="font-size: 12px; color: var(--text-gray);">Notices</div>
                                <div style="font-weight: 600; color: ${property.notices > 0 ? '#3b82f6' : 'var(--primary-color)'};">View (${property.notices})</div>
                            </div>
                            <div style="flex: 1; text-align: center; padding: 8px; background: rgba(8, 150, 126, 0.1); border-radius: 6px;">
                                <div style="font-size: 12px; color: var(--text-gray);">Expenses</div>
                                <div style="font-weight: 600; color: var(--primary-color);">${formatCurrency(property.expenses)}</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 16px; text-align: center; font-size: 14px; color: var(--text-gray);">
                            Click to manage this property
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function loadScheduledViewings() {
            try {
                // Try to load from database first
                const bookings = await DatabaseManager.getBookings({ 
                    tenant_id: currentUser.id, 
                    status: 'confirmed' 
                });
                
                if (bookings && bookings.length > 0) {
                    displayRealBookings(bookings);
                } else {
                    // Fallback to mock data for demonstration
                    loadMockScheduledViewingsWithRatings();
                }
            } catch (error) {
                console.log('Database bookings load failed, using mock data:', error);
                loadMockScheduledViewingsWithRatings();
            }
        }

        function loadMockScheduledViewings() {
            const mockViewings = [
                {
                    booking_id: 'booking1',
                    property_id: 'prop1',
                    property_name: 'Luxury Penthouse',
                    location: 'Upper East Side, Manhattan',
                    price: 3500,
                    viewing_date: '2025-10-25T14:00:00',
                    photos_urls: ['https://images.unsplash.com/photo-1512917774080-9991f1c4c750?w=400'],
                    status: 'confirmed'
                },
                {
                    booking_id: 'booking2',
                    property_id: 'prop2',
                    property_name: 'Waterfront Condo',
                    location: 'Marina Bay, Waterfront',
                    price: 2800,
                    viewing_date: '2025-10-28T16:30:00',
                    photos_urls: ['https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=400'],
                    status: 'confirmed'
                },
                {
                    booking_id: 'booking3',
                    property_id: 'prop3',
                    property_name: 'Garden View Townhouse',
                    location: 'Brooklyn Heights, Brooklyn',
                    price: 2200,
                    viewing_date: '2025-10-30T11:00:00',
                    photos_urls: ['https://images.unsplash.com/photo-1494526585095-c41746248156?w=400'],
                    status: 'confirmed'
                },
                {
                    booking_id: 'booking4',
                    property_id: 'prop4',
                    property_name: 'Industrial Loft',
                    location: 'SoHo, Downtown',
                    price: 2950,
                    viewing_date: '2025-11-02T15:00:00',
                    photos_urls: ['https://images.unsplash.com/photo-1484154218962-a197022b5858?w=400'],
                    status: 'confirmed'
                }
            ];

            const container = document.getElementById('scheduledViewings');
            container.innerHTML = mockViewings.map(viewing => `
                <div class="property-card">
                    <div class="property-image" style="background-image: url('${viewing.photos_urls[0]}'); height: 160px; background-size: cover; background-position: center; position: relative;">
                        <div style="position: absolute; top: 12px; right: 12px; background: #3b82f6; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                            VIEWING SCHEDULED
                        </div>
                    </div>
                    <div class="property-content">
                        <div class="property-title">${viewing.property_name}</div>
                        <div class="property-location">📍 ${viewing.location}</div>
                        <div class="property-price">${formatCurrency(viewing.price)}/month</div>
                        <div style="margin: 12px 0; padding: 8px; background: rgba(59, 130, 246, 0.1); border-radius: 6px;">
                            <div style="font-size: 14px; font-weight: 600; color: #3b82f6; margin-bottom: 4px;">📅 Viewing Scheduled</div>
                            <div style="font-size: 14px; color: var(--text-dark);">${formatDate(viewing.viewing_date)} at ${new Date(viewing.viewing_date).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</div>
                        </div>
                        <!-- Star Rating for Scheduled Properties -->
                        <div style="margin: 16px 0; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                            <div style="font-size: 14px; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">Rate this property</div>
                            <div class="star-rating" data-property-id="${viewing.property_id}" data-current-rating="${viewing.user_rating || 0}">
                                ${[1, 2, 3, 4, 5].map(star => `
                                    <span class="star" data-star="${star}" onclick="rateProperty('${viewing.property_id}', ${star})" style="cursor: pointer; font-size: 18px; color: ${star <= (viewing.user_rating || 0) ? '#FFD700' : '#E5E7EB'}; margin-right: 4px;">★</span>
                                `).join('')}
                                <span style="margin-left: 8px; font-size: 12px; color: var(--text-gray);">
                                    ${viewing.user_rating ? `Your rating: ${viewing.user_rating}/5` : 'Click to rate'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="property-actions">
                            <button class="btn-primary" onclick="viewPropertyDetails('${viewing.property_id}')">
                                View Details
                            </button>
                            <button class="btn-secondary" onclick="cancelViewing('${viewing.booking_id}')">
                                Cancel Viewing
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showUserSearchModal() {
            document.getElementById('searchRequestModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('searchRequestModal').style.display = 'none';
        }

        // User search request form submission
        document.getElementById('searchRequestForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                tenant_id: currentUser.id,
                tenant_name: currentUser.name,
                email: currentUser.email,
                phone_number: currentUser.phone_number,
                property_type_required: document.getElementById('propertyType').value,
                location_preferred: document.getElementById('location').value,
                price_range_min: parseFloat(document.getElementById('minPrice').value),
                price_range_max: parseFloat(document.getElementById('maxPrice').value),
                additional_requirements: document.getElementById('additionalInfo').value
            };

            const button = e.target.querySelector('button[type="submit"]');
            const buttonText = button.querySelector('.button-text');
            const loading = button.querySelector('.loading');

            try {
                button.disabled = true;
                buttonText.classList.add('hidden');
                loading.classList.remove('hidden');

                await DatabaseManager.createLead(formData);
                
                showNotification('Search request submitted successfully!', 'success');
                closeModal();
                e.target.reset();

            } catch (error) {
                console.error('Error submitting search request:', error);
                showNotification('Error submitting request. Please try again.', 'error');
            } finally {
                button.disabled = false;
                buttonText.classList.remove('hidden');
                loading.classList.add('hidden');
            }
        });

        function toggleDropdown() {
            const dropdown = document.getElementById('dropdownMenu');
            dropdown.classList.toggle('show');
        }

        async function logout() {
            await AuthManager.signOut();
        }

        function refreshViewings() {
            loadScheduledViewings();
            showNotification('Viewings refreshed', 'info');
        }

        function viewPropertyDetails(propertyId) {
            window.location.href = `property-details.html?id=${propertyId}`;
        }

        function openPropertyManagement(propertyId) {
            // Open property-specific management page
            window.location.href = `property-management.html?id=${propertyId}`;
        }

        async function cancelViewing(bookingId) {
            if (confirm('Are you sure you want to cancel this viewing?')) {
                try {
                    // Update booking status to cancelled
                    await supabase
                        .from('bookings')
                        .update({ status: 'cancelled' })
                        .eq('booking_id', bookingId);

                    showNotification('Viewing cancelled successfully', 'success');
                    loadScheduledViewings();
                } catch (error) {
                    console.error('Error cancelling viewing:', error);
                    showNotification('Error cancelling viewing', 'error');
                }
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.user-menu')) {
                document.getElementById('dropdownMenu').classList.remove('show');
            }
        });

        // Enhanced star rating functionality with database integration
        async function rateProperty(propertyId, rating) {
            try {
                // Update star display immediately for better UX
                const starContainer = document.querySelector(`.star-rating[data-property-id="${propertyId}"]`);
                const stars = starContainer.querySelectorAll('.star');
                stars.forEach((star, index) => {
                    star.style.color = index < rating ? '#FFD700' : '#E5E7EB';
                });
                
                // Update the rating text
                const ratingText = starContainer.querySelector('span:last-child');
                ratingText.textContent = `Your rating: ${rating}/5`;
                
                // Store in database using the enhanced rating system
                try {
                    await DatabaseManager.createPropertyRating({
                        property_id: propertyId,
                        user_id: currentUser.id,
                        rating: rating,
                        review: `Rated ${rating} stars from tenant dashboard`
                    });
                    
                    showNotification(`Property rated ${rating} star${rating !== 1 ? 's' : ''}! Owner rating updated.`, 'success');
                } catch (dbError) {
                    console.log('Database rating failed, storing locally:', dbError);
                    
                    // Fallback to localStorage for demo purposes
                    const propertyRatings = JSON.parse(localStorage.getItem('propertyRatings') || '{}');
                    propertyRatings[propertyId] = rating;
                    localStorage.setItem('propertyRatings', JSON.stringify(propertyRatings));
                    
                    await updateOwnerRating(propertyId, rating);
                    
                    showNotification(`Property rated ${rating} star${rating !== 1 ? 's' : ''}! Thank you for your feedback.`, 'success');
                }
                
            } catch (error) {
                console.error('Error rating property:', error);
                showNotification('Error submitting rating. Please try again.', 'error');
            }
        }
        
        async function updateOwnerRating(propertyId, rating) {
            try {
                // Get property details to find owner
                const property = await DatabaseManager.getPropertyById(propertyId);
                if (property && property.owner_id) {
                    // Calculate new average rating for owner
                    const ownerRatings = JSON.parse(localStorage.getItem('ownerRatings') || '{}');
                    if (!ownerRatings[property.owner_id]) {
                        ownerRatings[property.owner_id] = { ratings: [], average: 0 };
                    }
                    
                    ownerRatings[property.owner_id].ratings.push(rating);
                    const ratings = ownerRatings[property.owner_id].ratings;
                    ownerRatings[property.owner_id].average = ratings.reduce((a, b) => a + b) / ratings.length;
                    
                    localStorage.setItem('ownerRatings', JSON.stringify(ownerRatings));
                    
                    // In a real implementation, update the database
                    // await AuthManager.updateProfile({ rating: ownerRatings[property.owner_id].average });
                }
            } catch (error) {
                console.error('Error updating owner rating:', error);
            }
        }
        
        // Enhanced rating loading with database integration
        async function loadExistingRatings() {
            try {
                // Try to load ratings from database
                const properties = document.querySelectorAll('.star-rating[data-property-id]');
                for (const starContainer of properties) {
                    const propertyId = starContainer.getAttribute('data-property-id');
                    try {
                        const ratings = await DatabaseManager.getPropertyRatings(propertyId);
                        const userRating = ratings.find(r => r.user_id === currentUser.id);
                        
                        if (userRating) {
                            const rating = userRating.rating;
                            const stars = starContainer.querySelectorAll('.star');
                            stars.forEach((star, index) => {
                                star.style.color = index < rating ? '#FFD700' : '#E5E7EB';
                            });
                            const ratingText = starContainer.querySelector('span:last-child');
                            ratingText.textContent = `Your rating: ${rating}/5`;
                        }
                    } catch (dbError) {
                        console.log(`Database rating load failed for property ${propertyId}, checking localStorage`);
                    }
                }
            } catch (error) {
                console.log('Database ratings load failed, using localStorage:', error);
            }
            
            // Fallback to localStorage for any missing ratings
            const propertyRatings = JSON.parse(localStorage.getItem('propertyRatings') || '{}');
            Object.keys(propertyRatings).forEach(propertyId => {
                const rating = propertyRatings[propertyId];
                const starContainer = document.querySelector(`.star-rating[data-property-id="${propertyId}"]`);
                if (starContainer) {
                    const stars = starContainer.querySelectorAll('.star');
                    // Only update if not already set from database
                    if (stars[0].style.color !== 'rgb(255, 215, 0)') {
                        stars.forEach((star, index) => {
                            star.style.color = index < rating ? '#FFD700' : '#E5E7EB';
                        });
                        const ratingText = starContainer.querySelector('span:last-child');
                        ratingText.textContent = `Your rating: ${rating}/5`;
                    }
                }
            });
        }
        
        // Call loadExistingRatings after properties are loaded
        function loadMockPropertiesWithRatings() {
            loadMockProperties();
            setTimeout(loadExistingRatings, 100); // Small delay to ensure DOM is updated
        }
        
        function loadMockScheduledViewingsWithRatings() {
            loadMockScheduledViewings();
            setTimeout(loadExistingRatings, 100);
        }
        
        // New function to display real properties from database
        function displayRealProperties(tenantData) {
            const container = document.getElementById('currentProperties');
            container.innerHTML = tenantData.map(tenant => {
                const property = tenant.properties;
                const propertyId = property.property_id;
                
                return `
                    <div class="property-card" onclick="openPropertyManagement('${propertyId}')" style="cursor: pointer;">
                        <div class="property-image" style="background-image: url('${property.photos_urls?.[0] || 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=400'}'); height: 200px; background-size: cover; background-position: center; position: relative;">
                            <div style="position: absolute; top: 12px; right: 12px; background: var(--primary-color); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                                RENTING
                            </div>
                        </div>
                        <div class="property-content">
                            <div class="property-title">${property.property_name}</div>
                            <div class="property-location">📍 ${property.location}</div>
                            <div class="property-price">${formatCurrency(tenant.monthly_rent)}/month</div>
                            
                            <div style="margin: 12px 0; font-size: 14px; color: var(--text-gray);">
                                <div><strong>Lease Start:</strong> ${formatDate(tenant.lease_start_date)}</div>
                                <div><strong>Lease End:</strong> ${formatDate(tenant.lease_end_date)}</div>
                            </div>
                            
                            <!-- Star Rating Section -->
                            <div style="margin: 16px 0; padding: 12px; background: rgba(8, 150, 126, 0.1); border-radius: 8px;">
                                <div style="font-size: 14px; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">Rate this property</div>
                                <div class="star-rating" data-property-id="${propertyId}" data-current-rating="0">
                                    ${[1, 2, 3, 4, 5].map(star => `
                                        <span class="star" data-star="${star}" onclick="rateProperty('${propertyId}', ${star})" style="cursor: pointer; font-size: 20px; color: #E5E7EB; margin-right: 4px;">★</span>
                                    `).join('')}
                                    <span style="margin-left: 8px; font-size: 12px; color: var(--text-gray);">
                                        Click to rate
                                    </span>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 12px; margin-top: 16px;">
                                <div style="flex: 1; text-align: center; padding: 8px; background: rgba(8, 150, 126, 0.1); border-radius: 6px;">
                                    <div style="font-size: 12px; color: var(--text-gray);">Complaints</div>
                                    <div style="font-weight: 600; color: var(--primary-color);">Manage (0)</div>
                                </div>
                                <div style="flex: 1; text-align: center; padding: 8px; background: rgba(8, 150, 126, 0.1); border-radius: 6px;">
                                    <div style="font-size: 12px; color: var(--text-gray);">Notices</div>
                                    <div style="font-weight: 600; color: var(--primary-color);">View (0)</div>
                                </div>
                                <div style="flex: 1; text-align: center; padding: 8px; background: rgba(8, 150, 126, 0.1); border-radius: 6px;">
                                    <div style="font-size: 12px; color: var(--text-gray);">Status</div>
                                    <div style="font-weight: 600; color: var(--primary-color);">Active</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Load existing ratings after DOM update
            setTimeout(loadExistingRatings, 100);
        }
        
        // New function to display real bookings from database
        function displayRealBookings(bookings) {
            const container = document.getElementById('scheduledViewings');
            container.innerHTML = bookings.map(booking => {
                return `
                    <div class="property-card">
                        <div class="property-image" style="background-image: url('${booking.properties?.photos_urls?.[0] || 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=400'}'); height: 160px; background-size: cover; background-position: center; position: relative;">
                            <div style="position: absolute; top: 12px; right: 12px; background: #3b82f6; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                                VIEWING SCHEDULED
                            </div>
                        </div>
                        <div class="property-content">
                            <div class="property-title">${booking.property_name || booking.properties?.property_name}</div>
                            <div class="property-location">📍 ${booking.property_location || booking.properties?.location}</div>
                            <div style="margin: 12px 0; padding: 8px; background: rgba(59, 130, 246, 0.1); border-radius: 6px;">
                                <div style="font-size: 14px; font-weight: 600; color: #3b82f6; margin-bottom: 4px;">📅 Viewing Scheduled</div>
                                <div style="font-size: 14px; color: var(--text-dark);">${formatDate(booking.viewing_date)} at ${new Date(booking.viewing_date).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</div>
                            </div>
                            
                            <!-- Star Rating for Scheduled Properties -->
                            <div style="margin: 16px 0; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                                <div style="font-size: 14px; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">Rate this property</div>
                                <div class="star-rating" data-property-id="${booking.property_id}" data-current-rating="0">
                                    ${[1, 2, 3, 4, 5].map(star => `
                                        <span class="star" data-star="${star}" onclick="rateProperty('${booking.property_id}', ${star})" style="cursor: pointer; font-size: 18px; color: #E5E7EB; margin-right: 4px;">★</span>
                                    `).join('')}
                                    <span style="margin-left: 8px; font-size: 12px; color: var(--text-gray);">
                                        Click to rate
                                    </span>
                                </div>
                            </div>
                            
                            <div class="property-actions">
                                <button class="btn-primary" onclick="viewPropertyDetails('${booking.property_id}')">
                                    View Details
                                </button>
                                <button class="btn-secondary" onclick="cancelViewing('${booking.booking_id}')">
                                    Cancel Viewing
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Load existing ratings after DOM update
            setTimeout(loadExistingRatings, 100);
        }

        // Close modal when clicking outside
        document.getElementById('searchRequestModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>
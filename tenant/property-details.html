<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Details - Rento</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <style>
        .property-header {
            position: relative;
            margin-bottom: 32px;
        }
        
        .property-gallery {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            grid-template-rows: 300px 150px;
            gap: 8px;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 24px;
        }
        
        .gallery-main {
            grid-row: 1 / -1;
            position: relative;
        }
        
        .gallery-item {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            position: relative;
            cursor: pointer;
        }
        
        .gallery-overlay {
            position: absolute;
            bottom: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .property-info-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 32px;
            margin-bottom: 32px;
        }
        
        .property-main-info {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .property-booking-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            position: sticky;
            top: 20px;
            height: fit-content;
        }
        
        .property-title-section {
            margin-bottom: 24px;
        }
        
        .property-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 8px;
        }
        
        .property-location {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-gray);
            font-size: 1.1rem;
            margin-bottom: 16px;
        }
        
        .property-meta {
            display: flex;
            align-items: center;
            gap: 24px;
            flex-wrap: wrap;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-gray);
            font-size: 14px;
        }
        
        .property-price-section {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
        }
        
        .property-price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 4px;
        }
        
        .price-period {
            color: var(--text-gray);
            font-size: 16px;
        }
        
        .viewing-fee {
            margin-top: 12px;
            padding: 12px;
            background: rgba(8, 150, 126, 0.1);
            border-radius: 8px;
        }
        
        .viewing-fee-text {
            color: var(--primary-color);
            font-weight: 600;
            font-size: 14px;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 16px;
        }
        
        .amenities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .amenity-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f8fafc;
            border-radius: 8px;
            color: var(--text-gray);
            font-size: 14px;
        }
        
        .amenity-icon {
            color: var(--primary-color);
        }
        
        .property-description {
            line-height: 1.7;
            color: var(--text-gray);
            margin-bottom: 24px;
        }
        
        .owner-info {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
        }
        
        .owner-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .owner-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.5rem;
        }
        
        .owner-details h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
        }
        
        .owner-rating {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-gray);
            font-size: 14px;
        }
        
        .owner-contact {
            display: flex;
            gap: 12px;
        }
        
        .contact-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }
        
        .property-rating {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
        }
        
        .rating-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .rating-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .current-rating {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-gray);
            font-size: 14px;
        }
        
        .star-rating {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
        }
        
        .star {
            font-size: 28px;
            color: #e5e7eb;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .star:hover,
        .star.active {
            color: #fbbf24;
        }
        
        .star.filled {
            color: #fbbf24;
        }
        
        .rating-comment {
            margin-bottom: 16px;
        }
        
        .rating-actions {
            display: flex;
            gap: 12px;
        }
        
        .btn-rate {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-rate:hover:not(:disabled) {
            background: #0a8d73;
            transform: translateY(-2px);
        }
        
        .btn-rate:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-cancel {
            background: #f3f4f6;
            color: var(--text-gray);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-cancel:hover {
            background: #e5e7eb;
        }
        
        .rating-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 8px;
            color: #059669;
            font-size: 14px;
            font-weight: 500;
        }
        
        .btn-call {
            background: #10b981;
            color: white;
        }
        
        .btn-message {
            background: #3b82f6;
            color: white;
        }
        
        .calendar-section {
            margin-bottom: 24px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 16px;
        }
        
        .calendar-header {
            background: #f8fafc;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-gray);
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .calendar-day:hover {
            background: #f1f5f9;
        }
        
        .calendar-day.available {
            background: #dcfce7;
            color: #166534;
            font-weight: 500;
        }
        
        .calendar-day.selected {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        
        .calendar-day.unavailable {
            background: #fee2e2;
            color: #dc2626;
            opacity: 0.7;
        }
        
        .calendar-legend {
            display: flex;
            gap: 16px;
            font-size: 12px;
            margin-top: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
        
        .booking-form {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-top: 24px;
        }
        
        @media (max-width: 768px) {
            .property-gallery {
                grid-template-columns: 1fr;
                grid-template-rows: 250px repeat(4, 100px);
                height: auto;
            }
            
            .gallery-main {
                grid-row: 1;
            }
            
            .property-info-grid {
                grid-template-columns: 1fr;
                gap: 24px;
            }
            
            .property-booking-card {
                position: static;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container nav-content">
            <a href="home.html"><img src="../assets/rento-logo-dark.svg" alt="Rento" class="nav-logo"></a>
            
            <ul class="nav-links">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="properties.html" class="active">Properties</a></li>
                <li><a href="payments.html">Payments</a></li>
                <li><a href="profile.html">Profile</a></li>
            </ul>
            
            <div class="user-menu">
                <img src="../assets/default-avatar.png" alt="Profile" class="user-avatar" id="userAvatar" onclick="toggleDropdown()">
                <div class="dropdown-menu" id="dropdownMenu">
                    <a href="profile.html" class="dropdown-item">Profile</a>
                    <a href="#" class="dropdown-item" onclick="openAccountSwitcher()">Switch Account</a>
                    <a href="#" class="dropdown-item logout-btn" onclick="logout()">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
        <div class="mobile-nav-items">
            <a href="dashboard.html" class="mobile-nav-item">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                </svg>
                Dashboard
            </a>
            <a href="properties.html" class="mobile-nav-item active">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"/>
                </svg>
                Properties
            </a>
            <a href="payments.html" class="mobile-nav-item">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6z"/>
                </svg>
                Payments
            </a>
            <a href="profile.html" class="mobile-nav-item">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
                </svg>
                Profile
            </a>
        </div>
    </nav>

    <div class="dashboard-container">
        <!-- Back Navigation -->
        <div style="margin-bottom: 20px;">
            <button onclick="goBack()" class="btn-secondary" style="display: flex; align-items: center; gap: 8px;">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clipRule="evenodd"/>
                </svg>
                Back to Properties
            </button>
        </div>

        <!-- Property Gallery -->
        <div id="propertyGallery" class="property-gallery">
            <!-- Gallery will be populated by JavaScript -->
        </div>

        <!-- Property Info Grid -->
        <div class="property-info-grid">
            <!-- Main Property Information -->
            <div class="property-main-info">
                <!-- Property Title Section -->
                <div class="property-title-section">
                    <h1 id="propertyTitle" class="property-title">Loading...</h1>
                    <div id="propertyLocation" class="property-location">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path fillRule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clipRule="evenodd"/>
                        </svg>
                        <span>Loading location...</span>
                    </div>
                    <div id="propertyMeta" class="property-meta">
                        <!-- Meta information will be populated -->
                    </div>
                </div>

                <!-- Amenities Section -->
                <div>
                    <h2 class="section-title">Amenities</h2>
                    <div id="amenitiesGrid" class="amenities-grid">
                        <!-- Amenities will be populated -->
                    </div>
                </div>

                <!-- Description Section -->
                <div>
                    <h2 class="section-title">Description</h2>
                    <p id="propertyDescription" class="property-description">
                        Loading description...
                    </p>
                </div>

                <!-- Owner Information -->
                <div id="ownerInfo" class="owner-info">
                    <!-- Owner info will be populated -->
                </div>

                <!-- Property Rating Section -->
                <div id="propertyRating" class="property-rating">
                    <div class="rating-header">
                        <h3 class="rating-title">Rate this Property</h3>
                        <div id="currentRating" class="current-rating">
                            <span id="ratingDisplay">Loading...</span>
                        </div>
                    </div>
                    
                    <div id="ratingForm" style="display: none;">
                        <div class="star-rating" id="starRating">
                            <span class="star" data-rating="1">★</span>
                            <span class="star" data-rating="2">★</span>
                            <span class="star" data-rating="3">★</span>
                            <span class="star" data-rating="4">★</span>
                            <span class="star" data-rating="5">★</span>
                        </div>
                        
                        <div class="rating-comment">
                            <textarea id="ratingComment" class="form-textarea" rows="3" placeholder="Share your experience with this property (optional)..."></textarea>
                        </div>
                        
                        <div class="rating-actions">
                            <button id="submitRating" class="btn-rate" disabled>
                                <span class="button-text">Submit Rating</span>
                                <span class="loading hidden">Submitting...</span>
                            </button>
                            <button id="cancelRating" class="btn-cancel">Cancel</button>
                        </div>
                    </div>
                    
                    <div id="ratingStatus" style="display: none;">
                        <div class="rating-status">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd"/>
                            </svg>
                            <span id="statusMessage">Thank you for rating this property!</span>
                        </div>
                    </div>
                    
                    <button id="showRatingForm" class="btn-rate" style="width: 100%;">
                        Rate Property
                    </button>
                </div>

                <!-- Availability Calendar -->
                <div class="calendar-section">
                    <h2 class="section-title">Availability Calendar</h2>
                    <div class="calendar-container">
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Calendar headers -->
                            <div class="calendar-header">Sun</div>
                            <div class="calendar-header">Mon</div>
                            <div class="calendar-header">Tue</div>
                            <div class="calendar-header">Wed</div>
                            <div class="calendar-header">Thu</div>
                            <div class="calendar-header">Fri</div>
                            <div class="calendar-header">Sat</div>
                        </div>
                        <div class="calendar-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #dcfce7;"></div>
                                <span>Available</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #fee2e2;"></div>
                                <span>Unavailable</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--primary-color);"></div>
                                <span>Selected by Manager</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Booking Card -->
            <div class="property-booking-card">
                <div id="priceSection" class="property-price-section">
                    <!-- Price will be populated -->
                </div>

                <div class="form-group">
                    <label for="viewingDate" class="form-label">Select Viewing Date</label>
                    <input type="date" id="viewingDate" class="form-input" min="">
                </div>

                <div class="form-group">
                    <label for="viewingTime" class="form-label">Preferred Time</label>
                    <select id="viewingTime" class="form-select">
                        <option value="">Select time</option>
                        <option value="09:00">9:00 AM</option>
                        <option value="10:00">10:00 AM</option>
                        <option value="11:00">11:00 AM</option>
                        <option value="14:00">2:00 PM</option>
                        <option value="15:00">3:00 PM</option>
                        <option value="16:00">4:00 PM</option>
                        <option value="17:00">5:00 PM</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="viewingNotes" class="form-label">Additional Notes (Optional)</label>
                    <textarea id="viewingNotes" class="form-textarea" rows="3" placeholder="Any specific requirements or questions..."></textarea>
                </div>

                <button id="scheduleBtn" class="form-button" onclick="scheduleViewing()">
                    <span class="button-text">Schedule Viewing</span>
                    <span class="loading hidden">Scheduling...</span>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/auth.js"></script>
    <script>
        let currentUser = null;
        let currentProperty = null;
        let propertyId = null;
        let currentRating = 0;
        let userRating = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                currentUser = AuthManager.getCurrentUser();
                if (!currentUser) {
                    window.location.href = '../auth/login.html';
                    return;
                }

                // Get property ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                propertyId = urlParams.get('id');
                
                if (!propertyId) {
                    window.location.href = 'properties.html';
                    return;
                }

                // Update user avatar with profile photo or initials
                updateUserAvatar(currentUser);

                // Set minimum date to today
                document.getElementById('viewingDate').min = new Date().toISOString().split('T')[0];

                // Load property details
                await loadPropertyDetails();
                
                // Initialize rating system
                await loadPropertyRating();
                initializeRatingSystem();

            } catch (error) {
                console.error('Error initializing property details page:', error);
                showNotification('Error loading property details', 'error');
            }
        });

        // Update avatar when user switches accounts (listen for storage changes)
        window.addEventListener('storage', function(e) {
            if (e.key === 'user') {
                const newUser = e.newValue ? JSON.parse(e.newValue) : null;
                if (newUser) {
                    currentUser = newUser;
                    updateUserAvatar(currentUser);
                }
            }
        });

        async function loadPropertyDetails() {
            try {
                // Try to get from database first
                currentProperty = await DatabaseManager.getPropertyById(propertyId);
                
                if (!currentProperty) {
                    // Fallback to sample data
                    currentProperty = getSampleProperty(propertyId);
                }

                if (currentProperty) {
                    displayPropertyDetails(currentProperty);
                } else {
                    showNotification('Property not found', 'error');
                    setTimeout(() => {
                        window.location.href = 'properties.html';
                    }, 2000);
                }

            } catch (error) {
                console.error('Error loading property:', error);
                
                // Show sample property for demonstration
                currentProperty = getSampleProperty(propertyId);
                displayPropertyDetails(currentProperty);
            }
        }

        function getSampleProperty(id) {
            const sampleProperties = {
                '1': {
                    property_id: '1',
                    property_name: 'Modern Downtown Apartment',
                    location: 'Downtown, City Center',
                    property_type: 'apartment',
                    price: 1500,
                    amenities: ['WiFi', 'Gym', 'Pool', 'Parking', 'Air Conditioning', 'Laundry', 'Security', 'Elevator'],
                    description: 'Experience luxury living in this stunning modern apartment located in the heart of downtown. This beautifully designed space features floor-to-ceiling windows with breathtaking city views, high-end finishes throughout, and access to world-class amenities. Perfect for professionals who want to be at the center of it all.',
                    photos_urls: [
                        'https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?w=800',
                        'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800',
                        'https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?w=800',
                        'https://images.unsplash.com/photo-1484154218962-a197022b5858?w=800',
                        'https://images.unsplash.com/photo-1493809842364-78817add7ffb?w=800'
                    ],
                    status: 'for_rent',
                    viewing_fee: 25,
                    users: {
                        name: 'John Smith',
                        phone_number: '+1234567890',
                        rating: 4.8,
                        bio: 'Professional property manager with 10+ years of experience. Committed to providing excellent service and maintaining high-quality properties.',
                        profile_photo_url: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face&auto=format&q=80'
                    },
                    availability_calendar: {
                        available_dates: ['2025-01-15', '2025-01-16', '2025-01-20', '2025-01-22', '2025-01-25'],
                        selected_dates: ['2025-01-18', '2025-01-19', '2025-01-23']
                    }
                },
                '2': {
                    property_id: '2',
                    property_name: 'Cozy Studio Apartment',
                    location: 'Midtown, Close to Metro',
                    property_type: 'studio',
                    price: 900,
                    amenities: ['WiFi', 'Laundry', 'Pet-friendly', 'Heating', 'Kitchen', 'Furnished'],
                    description: 'Perfect studio apartment for young professionals or students. This cozy space is optimally designed to maximize comfort and functionality. Located just minutes from public transportation, shopping, and dining options.',
                    photos_urls: [
                        'https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?w=800',
                        'https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?w=800',
                        'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800'
                    ],
                    status: 'for_rent',
                    viewing_fee: null,
                    users: {
                        name: 'Sarah Johnson',
                        phone_number: '+1234567890',
                        rating: 4.6,
                        bio: 'Friendly and responsive landlord who cares about tenant satisfaction. Always available for maintenance requests and questions.',
                        profile_photo_url: 'https://images.unsplash.com/photo-1494790108755-2616b2e1a2b4?w=150&h=150&fit=crop&crop=face&auto=format&q=80'
                    },
                    availability_calendar: {
                        available_dates: ['2025-01-14', '2025-01-17', '2025-01-21', '2025-01-24'],
                        selected_dates: ['2025-01-16', '2025-01-18', '2025-01-22', '2025-01-25']
                    }
                }
            };

            return sampleProperties[id] || null;
        }

        function displayPropertyDetails(property) {
            // Property title and location
            document.getElementById('propertyTitle').textContent = property.property_name;
            document.getElementById('propertyLocation').innerHTML = `
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clipRule="evenodd"/>
                </svg>
                <span>${property.location}</span>
            `;

            // Property meta information
            document.getElementById('propertyMeta').innerHTML = `
                <div class="meta-item">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-9 9a1 1 0 001.414 1.414L2 12.414V17a1 1 0 001 1h3a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h3a1 1 0 001-1v-4.586l.293.293a1 1 0 001.414-1.414l-9-9z"/>
                    </svg>
                    <span>${property.property_type}</span>
                </div>
                <div class="meta-item">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z" clipRule="evenodd"/>
                    </svg>
                    <span>${property.status === 'for_rent' ? 'For Rent' : property.status === 'for_sale' ? 'For Sale' : 'Airbnb'}</span>
                </div>
            `;

            // Gallery
            displayGallery(property.photos_urls);

            // Price section
            document.getElementById('priceSection').innerHTML = `
                <div class="property-price">${formatCurrency(property.price)}</div>
                <div class="price-period">${property.status === 'for_rent' ? 'per month' : property.status === 'for_sale' ? 'total price' : 'per night'}</div>
                ${property.viewing_fee ? `
                    <div class="viewing-fee">
                        <div class="viewing-fee-text">Viewing fee: ${formatCurrency(property.viewing_fee)}</div>
                    </div>
                ` : ''}
            `;

            // Amenities
            displayAmenities(property.amenities);

            // Description
            document.getElementById('propertyDescription').textContent = property.description;

            // Owner information
            displayOwnerInfo(property.users);

            // Calendar
            displayCalendar(property.availability_calendar);
        }

        function displayGallery(photos) {
            const gallery = document.getElementById('propertyGallery');
            const photoUrls = photos || ['https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800'];
            
            gallery.innerHTML = `
                <div class="gallery-main gallery-item" style="background-image: url('${photoUrls[0]}');">
                    <div class="gallery-overlay">1 / ${photoUrls.length}</div>
                </div>
                ${photoUrls.slice(1, 5).map((url, index) => `
                    <div class="gallery-item" style="background-image: url('${url}');"></div>
                `).join('')}
            `;
        }

        function displayAmenities(amenities) {
            const grid = document.getElementById('amenitiesGrid');
            const amenityIcons = {
                'WiFi': '📶',
                'Gym': '🏋️',
                'Pool': '🏊',
                'Parking': '🚗',
                'Air Conditioning': '❄️',
                'Laundry': '🧺',
                'Security': '🔒',
                'Elevator': '🛗',
                'Pet-friendly': '🐕',
                'Heating': '🔥',
                'Kitchen': '🍳',
                'Furnished': '🛋️'
            };

            grid.innerHTML = (amenities || []).map(amenity => `
                <div class="amenity-item">
                    <span class="amenity-icon">${amenityIcons[amenity] || '✓'}</span>
                    <span>${amenity}</span>
                </div>
            `).join('');
        }

        function displayOwnerInfo(owner) {
            const ownerInfo = document.getElementById('ownerInfo');
            const initials = owner.name.split(' ').map(n => n[0]).join('').toUpperCase();
            
            ownerInfo.innerHTML = `
                <div class="owner-header">
                    <div class="owner-avatar">
                        ${owner.profile_photo_url ? 
                            `<img src="${owner.profile_photo_url}" alt="${owner.name}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" onerror="this.style.display='none'; this.parentNode.innerHTML='${initials}'; this.parentNode.style.display='flex'; this.parentNode.style.alignItems='center'; this.parentNode.style.justifyContent='center';">` :
                            initials
                        }
                    </div>
                    <div class="owner-details">
                        <h3>Hosted by ${owner.name}</h3>
                        <div class="owner-rating">
                            <span>⭐ ${owner.rating.toFixed(1)}</span>
                            <span>•</span>
                            <span>Superhost</span>
                        </div>
                    </div>
                </div>
                <p style="margin-bottom: 16px; color: var(--text-gray); line-height: 1.6;">
                    ${owner.bio || 'Professional property host committed to providing excellent service.'}
                </p>
                <div class="owner-contact">
                    <button class="contact-btn btn-call" onclick="callOwner('${owner.phone_number}')">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                        </svg>
                        Call
                    </button>
                    <button class="contact-btn btn-message" onclick="messageOwner()">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                            <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                        </svg>
                        Message
                    </button>
                </div>
            `;
        }

        function displayCalendar(calendar) {
            const calendarGrid = document.getElementById('calendarGrid');
            
            // Get current date and first day of month
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // Clear existing calendar days (keep headers)
            const headers = calendarGrid.querySelectorAll('.calendar-header');
            calendarGrid.innerHTML = '';
            headers.forEach(header => calendarGrid.appendChild(header));
            
            // Generate calendar days
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const dateString = currentDate.toISOString().split('T')[0];
                const dayNumber = currentDate.getDate();
                const isCurrentMonth = currentDate.getMonth() === month;
                const isToday = currentDate.toDateString() === now.toDateString();
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = dayNumber;
                
                if (!isCurrentMonth) {
                    dayElement.style.opacity = '0.3';
                } else if (calendar?.selected_dates?.includes(dateString)) {
                    dayElement.classList.add('selected');
                } else if (calendar?.available_dates?.includes(dateString)) {
                    dayElement.classList.add('available');
                } else if (currentDate >= now) {
                    dayElement.classList.add('unavailable');
                }
                
                if (isToday) {
                    dayElement.style.fontWeight = '700';
                    dayElement.style.textDecoration = 'underline';
                }
                
                calendarGrid.appendChild(dayElement);
            }
        }

        async function scheduleViewing() {
            if (!currentProperty) return;

            const viewingDate = document.getElementById('viewingDate').value;
            const viewingTime = document.getElementById('viewingTime').value;
            const notes = document.getElementById('viewingNotes').value;

            if (!viewingDate || !viewingTime) {
                showNotification('Please select both date and time for your viewing', 'error');
                return;
            }

            const bookingData = {
                tenant_id: currentUser.id,
                property_id: currentProperty.property_id,
                viewing_date: viewingDate + 'T' + viewingTime,
                status: 'pending',
                notes: notes
            };

            const button = document.getElementById('scheduleBtn');
            const buttonText = button.querySelector('.button-text');
            const loading = button.querySelector('.loading');

            try {
                button.disabled = true;
                buttonText.classList.add('hidden');
                loading.classList.remove('hidden');

                await DatabaseManager.createBooking(bookingData);
                
                showNotification('Viewing scheduled successfully! You will receive a confirmation soon.', 'success');
                
                // Reset form
                document.getElementById('viewingDate').value = '';
                document.getElementById('viewingTime').value = '';
                document.getElementById('viewingNotes').value = '';

            } catch (error) {
                console.error('Error scheduling viewing:', error);
                showNotification('Error scheduling viewing. Please try again.', 'error');
            } finally {
                button.disabled = false;
                buttonText.classList.remove('hidden');
                loading.classList.add('hidden');
            }
        }

        function callOwner(phoneNumber) {
            window.location.href = `tel:${phoneNumber}`;
        }

        function messageOwner() {
            showNotification('Messaging feature coming soon!', 'info');
        }

        function goBack() {
            window.history.back();
        }

        function toggleDropdown() {
            const dropdown = document.getElementById('dropdownMenu');
            dropdown.classList.toggle('show');
        }

        async function logout() {
            await AuthManager.signOut();
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.user-menu')) {
                document.getElementById('dropdownMenu').classList.remove('show');
            }
        });
        
        // Property Rating System Functions
        async function loadPropertyRating() {
            try {
                // Try to get user's existing rating for this property
                const userExistingRating = await DatabaseManager.getPropertyRating(currentUser.id, propertyId);
                userRating = userExistingRating;
                
                // Get average rating for this property
                const averageRating = await DatabaseManager.getPropertyAverageRating(propertyId);
                
                displayRatingStatus(userRating, averageRating);
                
            } catch (error) {
                console.error('Error loading property rating:', error);
                // Show demo rating status
                displayMockRatingStatus();
            }
        }
        
        function displayRatingStatus(userRating, averageRating) {
            const ratingDisplay = document.getElementById('ratingDisplay');
            const showRatingBtn = document.getElementById('showRatingForm');
            const ratingStatus = document.getElementById('ratingStatus');
            
            if (userRating) {
                // User has already rated this property
                ratingDisplay.innerHTML = `
                    <span>Your rating: ${generateStars(userRating.rating)} (${userRating.rating}/5)</span>
                `;
                showRatingBtn.style.display = 'none';
                ratingStatus.style.display = 'block';
                document.getElementById('statusMessage').textContent = `You rated this property ${userRating.rating} stars`;
            } else {
                // User hasn't rated yet
                if (averageRating && averageRating.count > 0) {
                    ratingDisplay.innerHTML = `
                        <span>Average: ${generateStars(averageRating.average)} (${averageRating.average.toFixed(1)}/5 from ${averageRating.count} ${averageRating.count === 1 ? 'rating' : 'ratings'})</span>
                    `;
                } else {
                    ratingDisplay.textContent = 'No ratings yet - Be the first to rate!';
                }
                showRatingBtn.style.display = 'block';
                ratingStatus.style.display = 'none';
            }
        }
        
        function displayMockRatingStatus() {
            const ratingDisplay = document.getElementById('ratingDisplay');
            const showRatingBtn = document.getElementById('showRatingForm');
            
            // Mock data - assume no user rating exists
            const mockRatings = {
                '1': { average: 4.3, count: 12 },
                '2': { average: 4.1, count: 8 }
            };
            
            const mockData = mockRatings[propertyId];
            if (mockData) {
                ratingDisplay.innerHTML = `
                    <span>Average: ${generateStars(mockData.average)} (${mockData.average}/5 from ${mockData.count} ${mockData.count === 1 ? 'rating' : 'ratings'})</span>
                `;
            } else {
                ratingDisplay.textContent = 'No ratings yet - Be the first to rate!';
            }
            
            showRatingBtn.style.display = 'block';
            document.getElementById('ratingStatus').style.display = 'none';
        }
        
        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            
            let stars = '';
            
            // Full stars
            for (let i = 0; i < fullStars; i++) {
                stars += '★';
            }
            
            // Half star
            if (hasHalfStar) {
                stars += '☆';
            }
            
            // Empty stars
            for (let i = 0; i < emptyStars; i++) {
                stars += '☆';
            }
            
            return `<span style="color: #fbbf24;">${stars}</span>`;
        }
        
        function initializeRatingSystem() {
            const showRatingBtn = document.getElementById('showRatingForm');
            const cancelRatingBtn = document.getElementById('cancelRating');
            const submitRatingBtn = document.getElementById('submitRating');
            const stars = document.querySelectorAll('.star');
            const ratingForm = document.getElementById('ratingForm');
            
            // Show rating form
            showRatingBtn.addEventListener('click', function() {
                ratingForm.style.display = 'block';
                showRatingBtn.style.display = 'none';
            });
            
            // Cancel rating
            cancelRatingBtn.addEventListener('click', function() {
                ratingForm.style.display = 'none';
                showRatingBtn.style.display = 'block';
                resetRatingForm();
            });
            
            // Star interaction
            stars.forEach(star => {
                star.addEventListener('mouseover', function() {
                    const rating = parseInt(this.dataset.rating);
                    highlightStars(rating);
                });
                
                star.addEventListener('click', function() {
                    currentRating = parseInt(this.dataset.rating);
                    highlightStars(currentRating, true);
                    submitRatingBtn.disabled = false;
                });
            });
            
            // Reset stars on mouse leave
            document.getElementById('starRating').addEventListener('mouseleave', function() {
                if (currentRating > 0) {
                    highlightStars(currentRating, true);
                } else {
                    resetStars();
                }
            });
            
            // Submit rating
            submitRatingBtn.addEventListener('click', submitPropertyRating);
        }
        
        function highlightStars(rating, permanent = false) {
            const stars = document.querySelectorAll('.star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add(permanent ? 'filled' : 'active');
                    if (permanent) star.classList.remove('active');
                } else {
                    star.classList.remove('active', 'filled');
                }
            });
        }
        
        function resetStars() {
            const stars = document.querySelectorAll('.star');
            stars.forEach(star => {
                star.classList.remove('active', 'filled');
            });
        }
        
        function resetRatingForm() {
            currentRating = 0;
            resetStars();
            document.getElementById('ratingComment').value = '';
            document.getElementById('submitRating').disabled = true;
        }
        
        async function submitPropertyRating() {
            if (!currentRating || !currentProperty) return;
            
            const comment = document.getElementById('ratingComment').value;
            const submitBtn = document.getElementById('submitRating');
            const buttonText = submitBtn.querySelector('.button-text');
            const loading = submitBtn.querySelector('.loading');
            
            try {
                submitBtn.disabled = true;
                buttonText.classList.add('hidden');
                loading.classList.remove('hidden');
                
                const ratingData = {
                    tenant_id: currentUser.id,
                    property_id: propertyId,
                    rating: currentRating,
                    comment: comment || null
                };
                
                await DatabaseManager.createPropertyRating(ratingData);
                
                showNotification('Rating submitted successfully!', 'success');
                
                // Update display
                document.getElementById('ratingForm').style.display = 'none';
                document.getElementById('ratingStatus').style.display = 'block';
                document.getElementById('statusMessage').textContent = `You rated this property ${currentRating} stars`;
                document.getElementById('ratingDisplay').innerHTML = `
                    <span>Your rating: ${generateStars(currentRating)} (${currentRating}/5)</span>
                `;
                
                // Mark as user has rated
                userRating = { rating: currentRating, comment: comment };
                
            } catch (error) {
                console.error('Error submitting rating:', error);
                showNotification('Error submitting rating. Please try again.', 'error');
            } finally {
                submitBtn.disabled = false;
                buttonText.classList.remove('hidden');
                loading.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
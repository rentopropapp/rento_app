<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Properties - Rento</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container nav-content">
            <a href="home.html"><img src="../assets/rento-logo-dark.svg" alt="Rento" class="nav-logo"></a>
            
            <ul class="nav-links">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="properties.html" class="active">Properties</a></li>
                <li><a href="payments.html">Payments</a></li>
                <li><a href="profile.html">Profile</a></li>
            </ul>
            
            <div class="user-menu">
                <img src="../assets/default-avatar.png" alt="Profile" class="user-avatar" id="userAvatar" onclick="toggleDropdown()" style="display: none;">
                <div style="background: var(--primary-color); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; cursor: pointer;" onclick="toggleDropdown()" id="userInitials">JD</div>
                <div class="dropdown-menu" id="dropdownMenu">
                    <a href="profile.html" class="dropdown-item">Profile</a>
                    <a href="../auth/login.html" class="dropdown-item">Switch Account</a>
                    <a href="#" class="dropdown-item logout-btn" onclick="logout()">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
        <div class="mobile-nav-items">
            <a href="dashboard.html" class="mobile-nav-item">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                </svg>
                Dashboard
            </a>
            <a href="properties.html" class="mobile-nav-item active">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"/>
                </svg>
                Properties
            </a>
            <a href="payments.html" class="mobile-nav-item">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6z"/>
                </svg>
                Payments
            </a>
            <a href="profile.html" class="mobile-nav-item">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
                </svg>
                Profile
            </a>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="page-header">
            <h1 class="page-title">Available Properties</h1>
            <p class="page-subtitle">Find your perfect rental property</p>
        </div>

        <!-- Search and Filters -->
        <div class="search-container">
            <div class="search-bar">
                <svg class="search-icon" fill="currentColor" viewBox="0 0 20 20" width="20">
                    <path fillRule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clipRule="evenodd"/>
                </svg>
                <input type="text" id="searchInput" class="search-input" placeholder="Search properties by location, type, or features...">
            </div>
            
            <div class="filter-row">
                <div class="filter-group">
                    <label for="propertyType" class="form-label">Property Type</label>
                    <select id="propertyType" class="form-select">
                        <option value="">All Types</option>
                        <option value="apartment">Apartment</option>
                        <option value="house">House</option>
                        <option value="studio">Studio</option>
                        <option value="commercial">Commercial</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="minPrice" class="form-label">Min Price</label>
                    <input type="number" id="minPrice" class="form-input" placeholder="0">
                </div>
                
                <div class="filter-group">
                    <label for="maxPrice" class="form-label">Max Price</label>
                    <input type="number" id="maxPrice" class="form-input" placeholder="Any">
                </div>
                
                <div class="filter-group">
                    <label for="status" class="form-label">Status</label>
                    <select id="status" class="form-select">
                        <option value="">All</option>
                        <option value="for_rent" selected>For Rent</option>
                        <option value="for_sale">For Sale</option>
                        <option value="airbnb">Airbnb</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <button class="btn-primary" onclick="applyFilters()">Filter</button>
                </div>
                
                <div class="filter-group">
                    <button class="btn-secondary" onclick="openSearchRequestModal()" style="display: flex; align-items: center; gap: 6px; white-space: nowrap; height: 40px;">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path fillRule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clipRule="evenodd"/>
                        </svg>
                        Request Property
                    </button>
                </div>
            </div>
        </div>

        <!-- Properties Grid -->
        <div id="propertiesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 24px;">
            <!-- Properties will be loaded here -->
            <div class="property-card">
                <div class="property-content">
                    <div style="text-align: center; padding: 40px 20px;">
                        <div class="loading"></div>
                        <p style="margin-top: 16px; color: var(--text-gray);">Loading properties...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Modal -->
    <div id="bookingModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Schedule Property Viewing</h2>
                <button class="modal-close" onclick="closeBookingModal()">&times;</button>
            </div>
            
            <div id="selectedPropertyInfo"></div>
            
            <form id="bookingForm">
                <div class="form-group">
                    <label for="viewingDate" class="form-label">Preferred Viewing Date</label>
                    <input type="date" id="viewingDate" class="form-input" required>
                </div>

                <div class="form-group">
                    <label for="viewingTime" class="form-label">Preferred Time</label>
                    <select id="viewingTime" class="form-select" required>
                        <option value="">Select time</option>
                        <option value="09:00">9:00 AM</option>
                        <option value="10:00">10:00 AM</option>
                        <option value="11:00">11:00 AM</option>
                        <option value="14:00">2:00 PM</option>
                        <option value="15:00">3:00 PM</option>
                        <option value="16:00">4:00 PM</option>
                        <option value="17:00">5:00 PM</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="viewingNotes" class="form-label">Additional Notes (Optional)</label>
                    <textarea id="viewingNotes" class="form-textarea" rows="3" placeholder="Any specific requirements or questions..."></textarea>
                </div>

                <button type="submit" class="form-button">
                    <span class="button-text">Schedule Viewing</span>
                    <span class="loading hidden">Scheduling...</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Search Request Modal -->
    <div id="searchRequestModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Submit Property Search Request</h2>
                <button class="modal-close" onclick="closeSearchRequestModal()">&times;</button>
            </div>
            
            <p style="color: var(--text-gray); margin-bottom: 24px; line-height: 1.6;">
                Can't find what you're looking for? Submit a search request and let our brokers find the perfect property for you.
            </p>
            
            <form id="searchRequestForm">
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div class="form-group">
                        <label for="tenantName" class="form-label">Full Name</label>
                        <input type="text" id="tenantName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="tenantEmail" class="form-label">Email Address</label>
                        <input type="email" id="tenantEmail" class="form-input" required>
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 16px;">
                    <label for="tenantPhone" class="form-label">Phone Number</label>
                    <input type="tel" id="tenantPhone" class="form-input" required>
                </div>

                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div class="form-group">
                        <label for="requestPropertyType" class="form-label">Property Type</label>
                        <select id="requestPropertyType" class="form-select" required>
                            <option value="">Select property type</option>
                            <option value="apartment">Apartment</option>
                            <option value="house">House</option>
                            <option value="studio">Studio</option>
                            <option value="commercial">Commercial</option>
                            <option value="student">Student Housing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="requestLocation" class="form-label">Preferred Location</label>
                        <input type="text" id="requestLocation" class="form-input" required placeholder="e.g., Downtown, Midtown">
                    </div>
                </div>

                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div class="form-group">
                        <label for="requestMinPrice" class="form-label">Minimum Budget</label>
                        <input type="number" id="requestMinPrice" class="form-input" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label for="requestMaxPrice" class="form-label">Maximum Budget</label>
                        <input type="number" id="requestMaxPrice" class="form-input" placeholder="Any" min="0">
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 24px;">
                    <label for="requestRequirements" class="form-label">Additional Requirements (Optional)</label>
                    <textarea id="requestRequirements" class="form-textarea" rows="4" placeholder="Describe any specific requirements, amenities, or preferences..."></textarea>
                </div>

                <button type="submit" class="form-button">
                    <span class="button-text">Submit Request</span>
                    <span class="loading hidden">Submitting...</span>
                </button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/auth.js"></script>
    <script>
        let currentUser = null;
        let allProperties = [];
        let selectedProperty = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                currentUser = AuthManager.getCurrentUser();
                if (!currentUser) {
                    window.location.href = '../auth/login.html';
                    return;
                }

                // Update user avatar with profile photo or initials
                updateUserAvatar(currentUser);
                
                // Update user initials or show profile photo
                const userInitials = document.getElementById('userInitials');
                const userAvatar = document.getElementById('userAvatar');
                
                if (currentUser.profile_photo_url) {
                    // Show profile photo
                    userAvatar.src = currentUser.profile_photo_url;
                    userAvatar.style.display = 'block';
                    userInitials.style.display = 'none';
                } else if (currentUser.name) {
                    // Show initials
                    const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
                    userInitials.textContent = initials;
                    userInitials.style.display = 'flex';
                    userAvatar.style.display = 'none';
                }

                // Set minimum date to today
                document.getElementById('viewingDate').min = new Date().toISOString().split('T')[0];

                // Load properties
                await loadProperties();

            } catch (error) {
                console.error('Error initializing properties page:', error);
                showNotification('Error loading properties', 'error');
            }
        });

        // Also update avatar when user switches accounts (listen for storage changes)
        window.addEventListener('storage', function(e) {
            if (e.key === 'user') {
                const newUser = e.newValue ? JSON.parse(e.newValue) : null;
                if (newUser) {
                    currentUser = newUser;
                    updateUserAvatar(currentUser);
                }
            }
        });

        async function loadProperties() {
            try {
                const filters = {
                    status: document.getElementById('status').value || 'for_rent'
                };
                
                allProperties = await DatabaseManager.getProperties(filters);
                displayProperties(allProperties);

            } catch (error) {
                console.error('Error loading properties:', error);
                
                // Show sample properties for demonstration
                allProperties = [
                    {
                        property_id: '1',
                        property_name: 'Modern Downtown Apartment',
                        location: 'Downtown, City Center',
                        property_type: 'apartment',
                        price: 1500,
                        amenities: ['WiFi', 'Gym', 'Pool', 'Parking'],
                        description: 'Beautiful modern apartment in the heart of downtown with amazing city views.',
                        photos_urls: ['https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?w=400'],
                        status: 'for_rent',
                        viewing_fee: 25,
                        users: {
                            name: 'John Smith',
                            phone_number: '+1234567890',
                            rating: 4.8,
                            profile_photo_url: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face&auto=format&q=80'
                        }
                    },
                    {
                        property_id: '2',
                        property_name: 'Cozy Studio Apartment',
                        location: 'Midtown, Close to Metro',
                        property_type: 'studio',
                        price: 900,
                        amenities: ['WiFi', 'Laundry', 'Pet-friendly'],
                        description: 'Perfect studio for young professionals. Close to public transportation.',
                        photos_urls: ['https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?w=400'],
                        status: 'for_rent',
                        viewing_fee: null,
                        users: {
                            name: 'Sarah Johnson',
                            phone_number: '+1234567890',
                            rating: 4.6,
                            profile_photo_url: 'https://images.unsplash.com/photo-1494790108755-2616b2e1a2b4?w=150&h=150&fit=crop&crop=face&auto=format&q=80'
                        }
                    }
                ];
                
                displayProperties(allProperties);
            }
        }

        function displayProperties(properties) {
            const grid = document.getElementById('propertiesGrid');
            
            if (properties.length === 0) {
                grid.innerHTML = `
                    <div class="property-card">
                        <div class="property-content">
                            <p style="text-align: center; color: var(--text-gray); padding: 40px 20px;">
                                No properties found. Try adjusting your filters.
                            </p>
                        </div>
                    </div>
                `;
                return;
            }

            grid.innerHTML = properties.map(property => `
                <div class="property-card">
                    <div class="property-image" style="background-image: url('${property.photos_urls?.[0] || 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=400'}');">
                        <div style="position: absolute; top: 12px; right: 12px; background: var(--primary-color); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                            ${property.status === 'for_rent' ? 'FOR RENT' : property.status === 'for_sale' ? 'FOR SALE' : 'AIRBNB'}
                        </div>
                    </div>
                    <div class="property-content">
                        <div class="property-title">${property.property_name}</div>
                        <div class="property-location">📍 ${property.location}</div>
                        <div class="property-price">${formatCurrency(property.price)}${property.status === 'for_rent' ? '/month' : ''}</div>
                        
                        <div class="property-features">
                            <span>${property.property_type}</span>
                            ${property.amenities ? property.amenities.slice(0, 3).map(amenity => `<span>${amenity}</span>`).join('') : ''}
                        </div>
                        
                        <p style="color: var(--text-gray); font-size: 14px; margin: 12px 0; line-height: 1.4;">
                            ${property.description?.substring(0, 100)}...
                        </p>
                        
                        ${property.viewing_fee ? `
                            <div style="background: rgba(8, 150, 126, 0.1); padding: 8px; border-radius: 6px; margin: 12px 0;">
                                <small style="color: var(--primary-color); font-weight: 500;">
                                    Viewing fee: ${formatCurrency(property.viewing_fee)}
                                </small>
                            </div>
                        ` : ''}
                        
                        <div style="display: flex; align-items: center; margin: 12px 0; font-size: 14px; color: var(--text-gray);">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                ${property.users?.profile_photo_url ? 
                                    `<img src="${property.users.profile_photo_url}" alt="${property.users.name}" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">` :
                                    ''
                                }
                                <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--primary-color); color: white; display: ${property.users?.profile_photo_url ? 'none' : 'flex'}; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">
                                    ${property.users?.name ? property.users.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : 'PO'}
                                </div>
                                <span>Listed by: ${property.users?.name || 'Property Owner'}</span>
                            </div>
                            ${property.users?.rating ? `
                                <span style="margin-left: auto;">
                                    ⭐ ${property.users.rating.toFixed(1)}
                                </span>
                            ` : ''}
                        </div>
                        
                        <div class="property-actions">
                            <button class="btn-primary" onclick="scheduleViewing('${property.property_id}')">
                                Schedule Viewing
                            </button>
                            <button class="btn-secondary" onclick="viewPropertyDetails('${property.property_id}')">
                                View Details
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function scheduleViewing(propertyId) {
            selectedProperty = allProperties.find(p => p.property_id === propertyId);
            if (!selectedProperty) return;

            document.getElementById('selectedPropertyInfo').innerHTML = `
                <div class="property-card" style="margin-bottom: 20px;">
                    <div class="property-content">
                        <div class="property-title">${selectedProperty.property_name}</div>
                        <div class="property-location">📍 ${selectedProperty.location}</div>
                        <div class="property-price">${formatCurrency(selectedProperty.price)}${selectedProperty.status === 'for_rent' ? '/month' : ''}</div>
                        ${selectedProperty.viewing_fee ? `
                            <div style="background: rgba(8, 150, 126, 0.1); padding: 8px; border-radius: 6px; margin-top: 12px;">
                                <small style="color: var(--primary-color); font-weight: 500;">
                                    Viewing fee: ${formatCurrency(selectedProperty.viewing_fee)}
                                </small>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.getElementById('bookingModal').style.display = 'flex';
        }

        function closeBookingModal() {
            document.getElementById('bookingModal').style.display = 'none';
            selectedProperty = null;
        }

        // Booking form submission
        document.getElementById('bookingForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!selectedProperty) return;

            const viewingDate = document.getElementById('viewingDate').value;
            const viewingTime = document.getElementById('viewingTime').value;
            
            if (!viewingDate || !viewingTime) {
                showNotification('Please select both date and time for viewing.', 'error');
                return;
            }

            const bookingData = {
                tenant_id: currentUser.id,
                property_id: selectedProperty.property_id,
                viewing_date: viewingDate + 'T' + viewingTime + ':00.000Z',
                status: 'pending',
                notes: document.getElementById('viewingNotes').value || '',
                tenant_name: currentUser.name,
                tenant_email: currentUser.email,
                tenant_phone: currentUser.phone_number || '',
                property_name: selectedProperty.property_name,
                property_location: selectedProperty.location,
                created_at: new Date().toISOString()
            };

            const button = e.target.querySelector('button[type="submit"]');
            const buttonText = button.querySelector('.button-text');
            const loading = button.querySelector('.loading');

            try {
                button.disabled = true;
                buttonText.classList.add('hidden');
                loading.classList.remove('hidden');

                // Try to create booking in database
                let bookingCreated = false;
                try {
                    await DatabaseManager.createBooking(bookingData);
                    bookingCreated = true;
                } catch (dbError) {
                    console.log('Database booking failed, storing locally:', dbError);
                    // Store booking locally for demo purposes
                    const localBookings = JSON.parse(localStorage.getItem('tenantBookings') || '[]');
                    localBookings.push({
                        ...bookingData,
                        booking_id: 'local_' + Date.now(),
                        created_at: new Date().toISOString()
                    });
                    localStorage.setItem('tenantBookings', JSON.stringify(localBookings));
                }
                
                // Also store in manager/broker bookings for them to see
                const managerBookings = JSON.parse(localStorage.getItem('managerBookings') || '[]');
                managerBookings.push({
                    ...bookingData,
                    booking_id: bookingCreated ? 'db_' + Date.now() : 'local_' + Date.now(),
                    created_at: new Date().toISOString()
                });
                localStorage.setItem('managerBookings', JSON.stringify(managerBookings));
                
                showNotification('Viewing scheduled successfully! The property manager will contact you soon.', 'success');
                closeBookingModal();
                e.target.reset();

            } catch (error) {
                console.error('Error scheduling viewing:', error);
                showNotification('Error scheduling viewing. Please try again.', 'error');
            } finally {
                button.disabled = false;
                buttonText.classList.remove('hidden');
                loading.classList.add('hidden');
            }
        });

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const propertyType = document.getElementById('propertyType').value;
            const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
            const maxPrice = parseFloat(document.getElementById('maxPrice').value) || Infinity;
            const status = document.getElementById('status').value;

            let filtered = allProperties.filter(property => {
                const matchesSearch = !searchTerm || 
                    property.property_name.toLowerCase().includes(searchTerm) ||
                    property.location.toLowerCase().includes(searchTerm) ||
                    property.description?.toLowerCase().includes(searchTerm);
                
                const matchesType = !propertyType || property.property_type === propertyType;
                const matchesPrice = property.price >= minPrice && property.price <= maxPrice;
                const matchesStatus = !status || property.status === status;

                return matchesSearch && matchesType && matchesPrice && matchesStatus;
            });

            displayProperties(filtered);
            showNotification(`Found ${filtered.length} properties`, 'info');
        }

        function viewPropertyDetails(propertyId) {
            window.location.href = `property-details.html?id=${propertyId}`;
        }

        function openSearchRequestModal() {
            // Pre-fill user information if available
            if (currentUser) {
                document.getElementById('tenantName').value = currentUser.name || '';
                document.getElementById('tenantEmail').value = currentUser.email || '';
                document.getElementById('tenantPhone').value = currentUser.phone_number || '';
            }
            
            document.getElementById('searchRequestModal').style.display = 'flex';
        }

        function closeSearchRequestModal() {
            document.getElementById('searchRequestModal').style.display = 'none';
        }

        function toggleDropdown() {
            const dropdown = document.getElementById('dropdownMenu');
            dropdown.classList.toggle('show');
        }

        async function logout() {
            await AuthManager.signOut();
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.user-menu')) {
                document.getElementById('dropdownMenu').classList.remove('show');
            }
        });

        // Close modal when clicking outside
        document.getElementById('bookingModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeBookingModal();
            }
        });

        // Real-time search
        document.getElementById('searchInput').addEventListener('input', function() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                applyFilters();
            }, 500);
        });

        // Apply filters when filter values change
        ['propertyType', 'minPrice', 'maxPrice', 'status'].forEach(id => {
            document.getElementById(id).addEventListener('change', applyFilters);
        });

        // Search request form submission
        document.getElementById('searchRequestForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                tenant_name: document.getElementById('tenantName').value,
                email: document.getElementById('tenantEmail').value,
                phone_number: document.getElementById('tenantPhone').value,
                property_type_required: document.getElementById('requestPropertyType').value,
                location_preferred: document.getElementById('requestLocation').value,
                price_range_min: parseFloat(document.getElementById('requestMinPrice').value) || 0,
                price_range_max: parseFloat(document.getElementById('requestMaxPrice').value) || null,
                additional_requirements: document.getElementById('requestRequirements').value,
                tenant_id: currentUser?.id || null,
                created_at: new Date().toISOString(),
                status: 'new'
            };

            const button = e.target.querySelector('button[type="submit"]');
            const buttonText = button.querySelector('.button-text');
            const loading = button.querySelector('.loading');

            try {
                button.disabled = true;
                buttonText.classList.add('hidden');
                loading.classList.remove('hidden');

                // Try to create lead in database
                let leadCreated = false;
                try {
                    await DatabaseManager.createLead(formData);
                    leadCreated = true;
                } catch (dbError) {
                    console.log('Database lead creation failed, storing locally:', dbError);
                }
                
                // Also store in broker leads for them to see
                const brokerLeads = JSON.parse(localStorage.getItem('brokerLeads') || '[]');
                brokerLeads.push({
                    ...formData,
                    lead_id: leadCreated ? 'db_' + Date.now() : 'local_' + Date.now(),
                    created_at: new Date().toISOString()
                });
                localStorage.setItem('brokerLeads', JSON.stringify(brokerLeads));
                
                showNotification('Your search request has been submitted successfully! Brokers will contact you soon.', 'success');
                closeSearchRequestModal();
                e.target.reset();

            } catch (error) {
                console.error('Error submitting search request:', error);
                showNotification('Error submitting search request. Please try again.', 'error');
            } finally {
                button.disabled = false;
                buttonText.classList.remove('hidden');
                loading.classList.add('hidden');
            }
        });

        // Close search request modal when clicking outside
        document.getElementById('searchRequestModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSearchRequestModal();
            }
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Manager Dashboard | Rento</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <style>
        /* Override global welcome-container styles */
        .property-welcome-container {
            background: white !important;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            padding: 60px 40px;
            text-align: center;
            margin: 80px auto;
            max-width: 600px;
            min-height: auto !important;
            position: static !important;
            display: block !important;
            align-items: unset !important;
            justify-content: unset !important;
            overflow: visible !important;
        }

        /* Override any background gradient */
        #welcomeState {
            background: #f8fafc !important;
            min-height: auto !important;
        }

        .welcome-icon {
            width: 80px;
            height: 80px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            color: white;
        }

        .welcome-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 12px;
        }

        .welcome-subtitle {
            font-size: 1rem;
            color: var(--text-gray);
            margin-bottom: 32px;
            line-height: 1.5;
        }

        .add-property-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .add-property-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(8, 150, 126, 0.3);
        }

        .properties-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .property-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .property-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .property-image {
            width: 100%;
            height: 200px;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .property-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .property-info {
            padding: 24px;
        }

        .property-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 6px;
        }

        .property-type {
            font-size: 0.875rem;
            color: var(--text-gray);
            margin-bottom: 4px;
        }

        .property-location {
            font-size: 0.875rem;
            color: var(--text-gray);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .property-price {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 16px;
        }

        .manage-btn {
            width: 100%;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .manage-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }


        @media (max-width: 768px) {
            .welcome-title {
                font-size: 2rem;
            }

            .properties-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container nav-content">
            <a href="home.html"><img src="../assets/rento-logo-dark.svg" alt="Rento" class="nav-logo"></a>
            
            <ul class="nav-links" id="navLinks" style="display: none;">
                <li><a href="home.html" class="active">Properties</a></li>
                <li><a href="profile.html">Profile</a></li>
            </ul>
            
            <div class="user-menu">
                <div style="background: var(--primary-color); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; cursor: pointer;" onclick="toggleDropdown()" id="userInitials">PM</div>
                <div class="dropdown-menu" id="dropdownMenu">
                    <a href="profile.html" class="dropdown-item">Profile</a>
                    <a href="#" class="dropdown-item">Switch Account</a>
                    <a href="#" class="dropdown-item logout-btn" onclick="logout()">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Welcome State (shown when no properties) -->
    <div id="welcomeState" class="dashboard-container">
        <div class="property-welcome-container">
            <div class="welcome-icon">
                <svg width="40" height="40" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-9 9a1 1 0 001.414 1.414L2 12.414V17a1 1 0 001 1h3a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h3a1 1 0 001-1v-4.586l.293.293a1 1 0 001.414-1.414l-9-9z"/>
                </svg>
            </div>
            <h1 class="welcome-title">Welcome to Rento!</h1>
            <p class="welcome-subtitle">
                Start by adding your first property to begin attracting tenants.
            </p>
            <button class="add-property-btn" onclick="startPropertyAddFlow()">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clipRule="evenodd"/>
                </svg>
                Add Your First Property
            </button>
        </div>
    </div>

    <!-- Properties List State (shown when properties exist) -->
    <div id="propertiesState" class="dashboard-container" style="display: none;">
        <div class="page-header">
            <h1 class="page-title">My Property Listings</h1>
            <p class="page-subtitle">Manage your properties and track their performance</p>
        </div>

        <div class="properties-grid" id="propertiesGrid">
            <!-- Properties will be loaded here -->
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/auth.js"></script>
    <script>
        let currentUser = null;
        let userProperties = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            try {
                currentUser = AuthManager.getCurrentUser();
                if (!currentUser) {
                    // Create a temporary user for testing
                    currentUser = {
                        email: 'test@propertymanager.com',
                        name: 'Property Manager',
                        role: 'property_manager'
                    };
                }

                if (currentUser.role !== 'property_manager') {
                    currentUser.role = 'property_manager'; // Force role for testing
                }

                // Update user initials
                if (currentUser.name) {
                    const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
                    document.getElementById('userInitials').textContent = initials;
                }

                // Load user properties and determine which state to show
                loadUserProperties();
            } catch (error) {
                console.error('Error initializing page:', error);
                // Create fallback user for testing
                currentUser = {
                    email: 'test@propertymanager.com',
                    name: 'Property Manager',
                    role: 'property_manager'
                };
                loadUserProperties();
            }
        });

        function loadUserProperties() {
            // Check for saved properties first
            const savedProperties = localStorage.getItem(`properties_${currentUser.email}`);
            
            if (savedProperties) {
                userProperties = JSON.parse(savedProperties);
            } else {
                // Add mock data for testing
                addSampleProperties();
            }

            if (userProperties.length === 0) {
                showWelcomeState();
            } else {
                showPropertiesState();
                renderProperties();
            }
        }

        function showWelcomeState() {
            document.getElementById('welcomeState').style.display = 'block';
            document.getElementById('propertiesState').style.display = 'none';
            document.getElementById('navLinks').style.display = 'none';
        }

        function showPropertiesState() {
            document.getElementById('welcomeState').style.display = 'none';
            document.getElementById('propertiesState').style.display = 'block';
            document.getElementById('navLinks').style.display = 'flex';
        }

        function renderProperties() {
            const grid = document.getElementById('propertiesGrid');
            grid.innerHTML = '';

            userProperties.forEach(property => {
                const propertyCard = createPropertyCard(property);
                grid.appendChild(propertyCard);
            });
        }

        function createPropertyCard(property) {
            const card = document.createElement('div');
            card.className = 'property-card';
            card.onclick = () => selectProperty(property.id);

            card.innerHTML = `
                <div class="property-image" style="background-image: url('${property.images && property.images[0] ? property.images[0] : 'https://via.placeholder.com/350x200?text=Property+Image'}')">
                    <div class="property-badge">${property.type}</div>
                </div>
                <div class="property-info">
                    <div class="property-name">${property.name}</div>
                    <div class="property-type">${property.type}</div>
                    <div class="property-location">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path fillRule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clipRule="evenodd"/>
                        </svg>
                        ${property.location}
                    </div>
                    <div class="property-price">UGX ${property.monthlyRent ? property.monthlyRent.toLocaleString() : '0'}/${property.purpose === 'airbnb' ? 'night' : 'month'}</div>
                    <button class="manage-btn" onclick="event.stopPropagation(); selectProperty('${property.id}')">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path fillRule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clipRule="evenodd"/>
                        </svg>
                        Manage Property
                    </button>
                </div>
            `;

            return card;
        }

        function startPropertyAddFlow() {
            // Redirect to property adding flow - Step 1: Property Type Selection
            window.location.href = 'add-property-type.html';
        }

        function selectProperty(propertyId) {
            // Store selected property ID and redirect to property-specific dashboard
            localStorage.setItem('selectedPropertyId', propertyId);
            window.location.href = `property-dashboard.html?id=${propertyId}`;
        }

        function toggleDropdown() {
            const dropdown = document.getElementById('dropdownMenu');
            dropdown.classList.toggle('show');
        }

        async function logout() {
            await AuthManager.signOut();
        }

        // Event listeners
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.user-menu')) {
                document.getElementById('dropdownMenu').classList.remove('show');
            }
        });

        // Add sample properties for testing
        function addSampleProperties() {
            const sampleProperties = [
                {
                    id: 'prop1',
                    name: 'Sunset Apartments',
                    type: 'flat_apartment',
                    location: 'Kampala, Kololo',
                    description: 'Modern 2-bedroom apartment with stunning city views and premium amenities.',
                    amenities: ['WiFi', 'Parking', 'Air Conditioning', 'Security System', 'Swimming Pool'],
                    hasViewingFee: true,
                    viewingFeeAmount: 50000,
                    leaseType: 'long_term',
                    purpose: 'rent',
                    monthlyRent: 1500000,
                    images: ['property-1-1.jpg', 'property-1-2.jpg', 'property-1-3.jpg'],
                    status: 'active',
                    managerId: currentUser.email,
                    dateAdded: new Date().toISOString(),
                    tenants: [
                        {
                            id: 'tenant1',
                            name: 'Sarah Nakamura',
                            email: 'sarah@email.com',
                            phone: '+256 700 123 456',
                            unit: 'A1',
                            rentAmount: 750000,
                            moveInDate: '2024-01-15',
                            nextPaymentDue: '2024-11-15'
                        }
                    ],
                    complaints: [
                        {
                            id: 'complaint1',
                            tenantName: 'Sarah Nakamura',
                            title: 'Water Pressure Issue',
                            description: 'Low water pressure in bathroom shower',
                            status: 'pending',
                            dateReported: '2024-10-15'
                        }
                    ],
                    bookings: [
                        {
                            id: 'booking1',
                            tenantName: 'John Doe',
                            email: 'john@email.com',
                            phone: '+256 701 234 567',
                            viewingDate: '2024-10-22',
                            viewingTime: '2:00 PM',
                            status: 'confirmed'
                        }
                    ],
                    payments: [
                        {
                            id: 'payment1',
                            tenantName: 'Sarah Nakamura',
                            amount: 750000,
                            datePaid: '2024-10-15',
                            unit: 'A1',
                            paymentType: 'rent'
                        }
                    ],
                    expenses: [
                        {
                            id: 'expense1',
                            description: 'Monthly Cleaning Service',
                            amount: 200000,
                            date: '2024-10-01',
                            category: 'maintenance'
                        }
                    ]
                },
                {
                    id: 'prop2',
                    name: 'Garden View Villa',
                    type: 'family_home',
                    location: 'Entebbe, Kitala',
                    description: 'Spacious 3-bedroom family home with beautiful garden and lake views.',
                    amenities: ['WiFi', 'Parking', 'Garden', 'Pet Friendly', 'Furnished'],
                    hasViewingFee: false,
                    viewingFeeAmount: 0,
                    leaseType: 'medium_term',
                    purpose: 'both',
                    monthlyRent: 2200000,
                    images: ['property-2-1.jpg', 'property-2-2.jpg', 'property-2-3.jpg'],
                    status: 'active',
                    managerId: currentUser.email,
                    dateAdded: new Date().toISOString(),
                    tenants: [],
                    complaints: [],
                    bookings: [
                        {
                            id: 'booking2',
                            tenantName: 'Mary Atuhaire',
                            email: 'mary@email.com',
                            phone: '+256 702 345 678',
                            viewingDate: '2024-10-25',
                            viewingTime: '10:00 AM',
                            status: 'pending'
                        }
                    ],
                    payments: [],
                    expenses: []
                },
                {
                    id: 'prop3',
                    name: 'City Center Studio',
                    type: 'student_housing',
                    location: 'Kampala, Wandegeya',
                    description: 'Affordable studio apartment perfect for students, close to Makerere University.',
                    amenities: ['WiFi', 'Laundry', 'Security System', 'Kitchen'],
                    hasViewingFee: true,
                    viewingFeeAmount: 25000,
                    leaseType: 'short_term',
                    purpose: 'rent',
                    monthlyRent: 450000,
                    images: ['property-3-1.jpg', 'property-3-2.jpg', 'property-3-3.jpg'],
                    status: 'active',
                    managerId: currentUser.email,
                    dateAdded: new Date().toISOString(),
                    tenants: [
                        {
                            id: 'tenant2',
                            name: 'James Mukasa',
                            email: 'james@email.com',
                            phone: '+256 703 456 789',
                            unit: 'Studio 5',
                            rentAmount: 450000,
                            moveInDate: '2024-09-01',
                            nextPaymentDue: '2024-11-01'
                        }
                    ],
                    complaints: [],
                    bookings: [],
                    payments: [
                        {
                            id: 'payment2',
                            tenantName: 'James Mukasa',
                            amount: 450000,
                            datePaid: '2024-10-01',
                            unit: 'Studio 5',
                            paymentType: 'rent'
                        }
                    ],
                    expenses: []
                }
            ];

            userProperties = sampleProperties;
            localStorage.setItem(`properties_${currentUser.email}`, JSON.stringify(sampleProperties));
        }
    </script>
</body>
</html>
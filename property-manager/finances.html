<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finances - Property Manager | Rento</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <style>
        .financial-overview {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 40px;
            border-radius: 16px;
            margin-bottom: 32px;
            text-align: center;
        }

        .total-revenue {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .revenue-period {
            font-size: 1.125rem;
            opacity: 0.9;
            margin-bottom: 24px;
        }

        .overview-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .overview-stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .finance-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 32px;
            margin-bottom: 32px;
        }

        .finance-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-title {
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 2px;
        }

        .transaction-details {
            font-size: 0.875rem;
            color: var(--text-gray);
        }

        .transaction-amount {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .amount-positive {
            color: #059669;
        }

        .amount-negative {
            color: #dc2626;
        }

        .expense-category {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
        }

        .category-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .category-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .category-name {
            font-weight: 500;
            color: var(--text-dark);
        }

        .category-amount {
            font-weight: 600;
            color: var(--text-dark);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            text-align: center;
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--text-gray);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .profit-positive {
            color: #059669;
        }

        .profit-negative {
            color: #dc2626;
        }

        .revenue-card {
            color: var(--primary-color);
        }

        .expense-card {
            color: #f59e0b;
        }

        .period-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .period-btn {
            padding: 8px 16px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .period-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .period-btn:hover {
            border-color: var(--primary-color);
        }

        .property-performance {
            margin-top: 32px;
        }

        .property-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .property-row:last-child {
            border-bottom: none;
        }

        .property-info {
            flex: 1;
        }

        .property-name {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 2px;
        }

        .property-units {
            font-size: 0.875rem;
            color: var(--text-gray);
        }

        .property-revenue {
            text-align: right;
        }

        .revenue-amount {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 2px;
        }

        .revenue-change {
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .change-positive {
            color: #059669;
        }

        .change-negative {
            color: #dc2626;
        }

        /* Page actions */
        .header-actions { display: flex; gap: 12px; align-items: center; }
        .add-btn { background: var(--primary-color); color: white; border: none; padding: 10px 16px; border-radius: 8px; font-size: 0.875rem; font-weight: 500; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: all 0.2s ease; }
        .add-btn:hover { background: var(--primary-dark); }
        .back-btn { background: white; color: var(--text-gray); border: 1px solid #e2e8f0; padding: 8px 16px; border-radius: 8px; text-decoration: none; font-size: 0.875rem; font-weight: 500; display: flex; align-items: center; gap: 8px; transition: all 0.2s ease; }
        .back-btn:hover { background: #f8fafc; color: var(--text-dark); }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; border-radius: 16px; padding: 24px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .modal-title { font-size: 1.25rem; font-weight: 600; color: var(--text-dark); margin: 0; }
        .modal-close { background: none; border: none; font-size: 1.5rem; color: var(--text-gray); cursor: pointer; }

        @media (max-width: 768px) {
            .finance-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .total-revenue {
                font-size: 2rem;
            }

            .overview-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1 class="page-title">Payments</h1>
                <p class="page-subtitle">Managing payments for <span id="propertyName">Selected Property</span></p>
            </div>
            <div class="header-actions">
                <button class="add-btn" onclick="openAddPaymentModal()">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clipRule="evenodd"/>
                    </svg>
                    Add Payment
                </button>
                <a href="property-dashboard.html" class="back-btn" id="backBtn">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clipRule="evenodd"/>
                    </svg>
                    Back to Dashboard
                </a>
            </div>
        </div>

        <!-- Financial Overview -->
        <div class="financial-overview">
            <div class="total-revenue">UGX 18,500,000</div>
            <div class="revenue-period">Total Revenue This Month</div>
            
            <div class="overview-stats">
                <div class="overview-stat">
                    <div class="stat-value">UGX 3.2M</div>
                    <div class="stat-label">Total Expenses</div>
                </div>
                <div class="overview-stat">
                    <div class="stat-value">UGX 15.3M</div>
                    <div class="stat-label">Net Profit</div>
                </div>
                <div class="overview-stat">
                    <div class="stat-value">82.7%</div>
                    <div class="stat-label">Profit Margin</div>
                </div>
                <div class="overview-stat">
                    <div class="stat-value">92%</div>
                    <div class="stat-label">Collection Rate</div>
                </div>
            </div>
        </div>

        <!-- Period Selector -->
        <div class="period-selector">
            <button class="period-btn active" onclick="selectPeriod('month')">This Month</button>
            <button class="period-btn" onclick="selectPeriod('quarter')">Quarter</button>
            <button class="period-btn" onclick="selectPeriod('year')">Year</button>
        </div>

        <!-- Financial Breakdown -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number revenue-card">UGX 18.5M</div>
                <div class="stat-label">Total Revenue</div>
            </div>
            <div class="stat-card">
                <div class="stat-number expense-card">UGX 3.2M</div>
                <div class="stat-label">Total Expenses</div>
            </div>
            <div class="stat-card">
                <div class="stat-number profit-positive">UGX 15.3M</div>
                <div class="stat-label">Net Profit</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">42</div>
                <div class="stat-label">Active Tenants</div>
            </div>
        </div>

        <!-- Main Finance Grid -->
        <div class="finance-grid">
            <!-- Recent Transactions -->
            <div class="finance-section" id="transactionsSection">
                <h2 class="section-title">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clipRule="evenodd"/>
                    </svg>
                    Recent Transactions
                </h2>

                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-title">Rent Payment - Garden View Apt</div>
                        <div class="transaction-details">Sarah Johnson • Unit 2B</div>
                    </div>
                    <div class="transaction-amount amount-positive">+UGX 800,000</div>
                </div>

                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-title">Maintenance - Plumbing Repair</div>
                        <div class="transaction-details">Hillview Heights • Unit 3A</div>
                    </div>
                    <div class="transaction-amount amount-negative">-UGX 150,000</div>
                </div>

                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-title">Rent Payment - Sunset Heights</div>
                        <div class="transaction-details">Agnes Nakato • Unit 1A</div>
                    </div>
                    <div class="transaction-amount amount-positive">+UGX 900,000</div>
                </div>

                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-title">Property Insurance</div>
                        <div class="transaction-details">Annual premium payment</div>
                    </div>
                    <div class="transaction-amount amount-negative">-UGX 250,000</div>
                </div>

                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-title">Rent Payment - Garden View Apt</div>
                        <div class="transaction-details">James Mwangi • Unit 4C</div>
                    </div>
                    <div class="transaction-amount amount-positive">+UGX 750,000</div>
                </div>

                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-title">Utilities - Electricity</div>
                        <div class="transaction-details">Common areas power bill</div>
                    </div>
                    <div class="transaction-amount amount-negative">-UGX 80,000</div>
                </div>
            </div>

            <!-- Expense Breakdown -->
            <div class="finance-section">
                <h2 class="section-title">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                    </svg>
                    Expense Breakdown
                </h2>

                <div class="expense-category">
                    <div class="category-info">
                        <div class="category-color" style="background: #dc2626;"></div>
                        <div class="category-name">Maintenance</div>
                    </div>
                    <div class="category-amount">UGX 1,200,000</div>
                </div>

                <div class="expense-category">
                    <div class="category-info">
                        <div class="category-color" style="background: #f59e0b;"></div>
                        <div class="category-name">Utilities</div>
                    </div>
                    <div class="category-amount">UGX 480,000</div>
                </div>

                <div class="expense-category">
                    <div class="category-info">
                        <div class="category-color" style="background: #3b82f6;"></div>
                        <div class="category-name">Insurance</div>
                    </div>
                    <div class="category-amount">UGX 350,000</div>
                </div>

                <div class="expense-category">
                    <div class="category-info">
                        <div class="category-color" style="background: #10b981;"></div>
                        <div class="category-name">Management Fees</div>
                    </div>
                    <div class="category-amount">UGX 720,000</div>
                </div>

                <div class="expense-category">
                    <div class="category-info">
                        <div class="category-color" style="background: #8b5cf6;"></div>
                        <div class="category-name">Marketing</div>
                    </div>
                    <div class="category-amount">UGX 180,000</div>
                </div>

                <div class="expense-category">
                    <div class="category-info">
                        <div class="category-color" style="background: #6b7280;"></div>
                        <div class="category-name">Other</div>
                    </div>
                    <div class="category-amount">UGX 270,000</div>
                </div>
            </div>
        </div>

        <!-- Property Performance -->
        <div class="finance-section property-performance">
            <h2 class="section-title">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-9 9a1 1 0 001.414 1.414L2 12.414V17a1 1 0 001 1h3a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h3a1 1 0 001-1v-4.586l.293.293a1 1 0 001.414-1.414l-9-9z"/>
                </svg>
                Property Performance
            </h2>

            <div class="property-row">
                <div class="property-info">
                    <div class="property-name">Garden View Apartments</div>
                    <div class="property-units">12 units • 100% occupied</div>
                </div>
                <div class="property-revenue">
                    <div class="revenue-amount">UGX 9,600,000</div>
                    <div class="revenue-change change-positive">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path fillRule="evenodd" d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z" clipRule="evenodd"/>
                        </svg>
                        +12%
                    </div>
                </div>
            </div>

            <div class="property-row">
                <div class="property-info">
                    <div class="property-name">Hillview Heights</div>
                    <div class="property-units">8 units • 87% occupied</div>
                </div>
                <div class="property-revenue">
                    <div class="revenue-amount">UGX 4,550,000</div>
                    <div class="revenue-change change-positive">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path fillRule="evenodd" d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z" clipRule="evenodd"/>
                        </svg>
                        +8%
                    </div>
                </div>
            </div>

            <div class="property-row">
                <div class="property-info">
                    <div class="property-name">Sunset Heights</div>
                    <div class="property-units">6 units • 83% occupied</div>
                </div>
                <div class="property-revenue">
                    <div class="revenue-amount">UGX 4,350,000</div>
                    <div class="revenue-change change-negative">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path fillRule="evenodd" d="M14.707 12.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l2.293-2.293a1 1 0 011.414 0z" clipRule="evenodd"/>
                        </svg>
                        -3%
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Payment Modal -->
    <div id="addPaymentModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Payment</h2>
                <button class="modal-close" onclick="closeAddPaymentModal()">&times;</button>
            </div>
            <form id="addPaymentForm" onsubmit="submitPayment(event)">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-bottom: 16px;">
                    <div>
                        <label class="filter-label">Payer (Tenant)</label>
                        <input type="text" id="paymentPayer" required class="form-input" placeholder="e.g. Sarah Johnson" style="width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
                    </div>
                    <div>
                        <label class="filter-label">Amount (UGX)</label>
                        <input type="number" id="paymentAmount" required class="form-input" placeholder="e.g. 800000" style="width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
                    </div>
                    <div>
                        <label class="filter-label">Date</label>
                        <input type="date" id="paymentDate" required class="form-input" style="width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
                    </div>
                    <div>
                        <label class="filter-label">Method</label>
                        <select id="paymentMethod" required class="form-input" style="width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; background: white;">
                            <option value="Mobile Money">Mobile Money</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="filter-label">Notes</label>
                    <textarea id="paymentNotes" rows="3" class="form-input" placeholder="Optional" style="width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px;"></textarea>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 16px;">
                    <button type="button" class="btn-secondary action-btn" onclick="closeAddPaymentModal()">Cancel</button>
                    <button type="submit" class="btn-primary action-btn">Save Payment</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/auth.js"></script>
    <script>
        let currentUser = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            currentUser = AuthManager.getCurrentUser();
            if (!currentUser) {
                window.location.href = '../auth/login.html';
                return;
            }

            if (currentUser.role !== 'property_manager') {
                window.location.href = '../auth/login.html';
                return;
            }

            // Load property context from query/localStorage
            const urlParams = new URLSearchParams(window.location.search);
            const propertyId = urlParams.get('property') || localStorage.getItem('selectedPropertyId');
            if (propertyId) {
                localStorage.setItem('selectedPropertyId', propertyId);
                const backBtn = document.getElementById('backBtn');
                if (backBtn) backBtn.href = `property-dashboard.html?id=${propertyId}`;

                // Try get property name from localStorage mock data
                try {
                    const saved = localStorage.getItem(`properties_${currentUser.email}`);
                    if (saved) {
                        const props = JSON.parse(saved);
                        const prop = props.find(p => p.id === propertyId);
                        if (prop && prop.name) {
                            const nameEl = document.getElementById('propertyName');
                            if (nameEl) nameEl.textContent = prop.name;
                        }
                    }
                } catch (e) { /* ignore */ }
            }
        });

        function selectPeriod(period) {
            // Update active button
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update financial data based on period
            console.log('Selected period:', period);
            showNotification(`Updating data for: ${period}`, 'info');
        }

        function toggleDropdown() {
            const dropdown = document.getElementById('dropdownMenu');
            dropdown.classList.toggle('show');
        }

        async function logout() {
            await AuthManager.signOut();
        }

        // Event listeners
        document.addEventListener('click', function(e) {
            const dd = document.getElementById('dropdownMenu');
            if (dd && !e.target.closest('.user-menu')) {
                dd.classList.remove('show');
            }
        });

        // Payments modal helpers
        function openAddPaymentModal() {
            document.getElementById('addPaymentModal').style.display = 'flex';
            // Default date to today
            const d = document.getElementById('paymentDate');
            if (d) d.valueAsDate = new Date();
        }
        function closeAddPaymentModal() { document.getElementById('addPaymentModal').style.display = 'none'; }
        function submitPayment(event) {
            event.preventDefault();
            const payer = document.getElementById('paymentPayer').value.trim();
            const amount = parseFloat(document.getElementById('paymentAmount').value || '0');
            const date = document.getElementById('paymentDate').value;
            const method = document.getElementById('paymentMethod').value;
            if (!payer || !amount || !date || !method) return;

            // Add a new transaction item at the top of the Recent Transactions section (UI only)
            const section = document.getElementById('transactionsSection');
            if (section) {
                const firstItem = section.querySelector('.transaction-item');
                const div = document.createElement('div');
                div.className = 'transaction-item';
                div.innerHTML = `
                    <div class="transaction-info">
                        <div class="transaction-title">Rent Payment - ${payer}</div>
                        <div class="transaction-details">${method}</div>
                    </div>
                    <div class="transaction-amount amount-positive">+UGX ${amount.toLocaleString()}</div>
                `;
                if (firstItem) {
                    section.insertBefore(div, firstItem);
                } else {
                    section.appendChild(div);
                }
            }
            closeAddPaymentModal();
            showNotification('Payment recorded', 'success');
            document.getElementById('addPaymentForm').reset();
        }

        // Close modal when clicking outside content
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('addPaymentModal');
            if (modal && e.target === modal) closeAddPaymentModal();
        });
    </script>
</body>
</html>
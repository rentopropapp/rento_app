<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users & Roles | Rento</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <style>
        .users-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            margin-bottom: 100px;
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .back-btn {
            background: white;
            color: var(--text-gray);
            border: 1px solid #e2e8f0;
            padding: 8px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: #f8fafc;
            color: var(--text-dark);
        }

        .add-user-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s ease;
        }

        .add-user-btn:hover {
            background: var(--primary-dark);
        }

        .users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .user-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease;
        }

        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .user-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .user-info h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-dark);
            margin: 0 0 4px 0;
        }

        .user-email {
            color: var(--text-gray);
            font-size: 0.875rem;
            margin-bottom: 4px;
        }

        .role-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .role-admin {
            background: #fef3c7;
            color: #92400e;
        }

        .role-manager {
            background: #dcfce7;
            color: #166534;
        }

        .role-assistant {
            background: #dbeafe;
            color: #1e40af;
        }

        .role-viewer {
            background: #f3f4f6;
            color: #374151;
        }

        .permissions-list {
            margin-top: 16px;
        }

        .permissions-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .permission-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            color: var(--text-gray);
            margin-bottom: 4px;
        }

        .permission-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .permission-granted {
            background: #10b981;
        }

        .permission-denied {
            background: #ef4444;
        }

        .user-actions {
            display: flex;
            gap: 8px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-edit {
            background: #f0f9ff;
            color: #0369a1;
        }

        .btn-edit:hover {
            background: #e0f2fe;
        }

        .btn-remove {
            background: #fef2f2;
            color: #dc2626;
        }

        .btn-remove:hover {
            background: #fee2e2;
        }

        .role-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .role-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .role-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .role-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .admin-icon { background: #f59e0b; }
        .manager-icon { background: #10b981; }
        .assistant-icon { background: #3b82f6; }
        .viewer-icon { background: #6b7280; }

        .role-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-dark);
            margin: 0;
        }

        .role-description {
            color: var(--text-gray);
            font-size: 0.875rem;
            margin-bottom: 16px;
        }

        .permissions-grid {
            display: grid;
            gap: 8px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-dark);
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-gray);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(8, 150, 126, 0.1);
        }

        .form-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
            width: 100%;
        }

        .form-button:hover {
            background: var(--primary-dark);
        }

        @media (max-width: 768px) {
            .users-container {
                padding: 16px;
            }

            .page-header {
                flex-direction: column;
                align-items: stretch;
                gap: 16px;
            }

            .users-grid, .role-sections {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container nav-content">
            <img src="../assets/rento-logo-dark.svg" alt="Rento" class="nav-logo">
            
            <div class="user-menu">
                <div style="background: var(--primary-color); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; cursor: pointer;" onclick="toggleDropdown()" id="userInitials">PM</div>
                <div class="dropdown-menu" id="dropdownMenu">
                    <a href="manager-profile.html" class="dropdown-item">Profile</a>
                    <a href="#" class="dropdown-item">Switch Account</a>
                    <a href="#" class="dropdown-item logout-btn" onclick="logout()">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="users-container">
        <!-- Page Header -->
        <div class="page-header">
            <div>
                <h1 style="font-size: 1.875rem; font-weight: 700; color: var(--text-dark); margin: 0;">Users & Roles</h1>
                <p style="color: var(--text-gray); margin: 8px 0 0 0;">Manage property access and user permissions</p>
            </div>
            <div style="display: flex; gap: 12px; align-items: center;">
                <a href="property-dashboard.html" class="back-btn" id="backBtn">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clipRule="evenodd"/>
                    </svg>
                    Back to Dashboard
                </a>
                <button class="add-user-btn" onclick="showAddUserModal()">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clipRule="evenodd"/>
                    </svg>
                    Add User
                </button>
            </div>
        </div>

        <!-- Role Definitions -->
        <div class="role-sections">
            <div class="role-section">
                <div class="role-header">
                    <div class="role-icon admin-icon">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                            <path fillRule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd"/>
                        </svg>
                    </div>
                    <h3 class="role-title">Property Admin</h3>
                </div>
                <p class="role-description">Full access to all property management features including finances and user management.</p>
                <div class="permissions-grid">
                    <div class="permission-item">
                        <div class="permission-icon permission-granted"></div>
                        <span>Manage all properties</span>
                    </div>
                    <div class="permission-item">
                        <div class="permission-icon permission-granted"></div>
                        <span>Financial management</span>
                    </div>
                    <div class="permission-item">
                        <div class="permission-icon permission-granted"></div>
                        <span>User & role management</span>
                    </div>
                    <div class="permission-item">
                        <div class="permission-icon permission-granted"></div>
                        <span>Generate reports</span>
                    </div>
                </div>
            </div>

            <div class="role-section">
                <div class="role-header">
                    <div class="role-icon manager-icon">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10.707 2.293a1 1 0 00-1.414 0l-9 9a1 1 0 001.414 1.414L2 12.414V17a1 1 0 001 1h3a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h3a1 1 0 001-1v-4.586l.293.293a1 1 0 001.414-1.414l-9-9z"/>
                        </svg>
                    </div>
                    <h3 class="role-title">Property Manager</h3>
                </div>
                <p class="role-description">Manage assigned properties, tenants, and maintenance without financial access.</p>
                <div class="permissions-grid">
                    <div class="permission-item">
                        <div class="permission-icon permission-granted"></div>
                        <span>Manage assigned properties</span>
                    </div>
                    <div class="permission-item">
                        <div class="permission-icon permission-granted"></div>
                        <span>Tenant management</span>
                    </div>
                    <div class="permission-item">
                        <div class="permission-icon permission-granted"></div>
                        <span>Maintenance requests</span>
                    </div>
                    <div class="permission-item">
                        <div class="permission-icon permission-denied"></div>
                        <span>Financial management</span>
                    </div>
                </div>
            </div>

            <div class="role-section">
                <div class="role-header">
                    <div class="role-icon assistant-icon">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                            <path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd"/>
                        </svg>
                    </div>
                    <h3 class="role-title">Assistant</h3>
                </div>
                <p class="role-description">Limited access to help with bookings and basic tenant communication.</p>
                <div class="permissions-grid">
                    <div class="permission-item">
                        <div class="permission-icon permission-granted"></div>
                        <span>View property information</span>
                    </div>
                    <div class="permission-item">
                        <div class="permission-icon permission-granted"></div>
                        <span>Manage bookings</span>
                    </div>
                    <div class="permission-item">
                        <div class="permission-icon permission-granted"></div>
                        <span>Basic tenant communication</span>
                    </div>
                    <div class="permission-item">
                        <div class="permission-icon permission-denied"></div>
                        <span>Edit property details</span>
                    </div>
                </div>
            </div>

            <div class="role-section">
                <div class="role-header">
                    <div class="role-icon viewer-icon">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                            <path fillRule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clipRule="evenodd"/>
                        </svg>
                    </div>
                    <h3 class="role-title">Viewer</h3>
                </div>
                <p class="role-description">Read-only access to view property information and reports.</p>
                <div class="permissions-grid">
                    <div class="permission-item">
                        <div class="permission-icon permission-granted"></div>
                        <span>View property information</span>
                    </div>
                    <div class="permission-item">
                        <div class="permission-icon permission-granted"></div>
                        <span>View reports</span>
                    </div>
                    <div class="permission-item">
                        <div class="permission-icon permission-denied"></div>
                        <span>Edit any information</span>
                    </div>
                    <div class="permission-item">
                        <div class="permission-icon permission-denied"></div>
                        <span>Manage users</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Users -->
        <h2 style="font-size: 1.5rem; font-weight: 600; color: var(--text-dark); margin-bottom: 24px;">Current Users</h2>
        <div class="users-grid" id="usersGrid">
            <!-- Users will be loaded here -->
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New User</h2>
                <button class="modal-close" onclick="closeAddUserModal()">&times;</button>
            </div>
            
            <form id="addUserForm">
                <div class="form-group">
                    <label class="form-label" for="userName">Full Name</label>
                    <input type="text" id="userName" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="userEmail">Email Address</label>
                    <input type="email" id="userEmail" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="userRole">Role</label>
                    <select id="userRole" class="form-select" required>
                        <option value="">Select Role</option>
                        <option value="admin">Property Admin</option>
                        <option value="manager">Property Manager</option>
                        <option value="assistant">Assistant</option>
                        <option value="viewer">Viewer</option>
                    </select>
                </div>

                <button type="submit" class="form-button">Add User</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/auth.js"></script>
    <script>
        let currentUser = null;
        let users = [
            {
                id: 1,
                name: 'John Doe',
                email: 'john.doe@rento.com',
                role: 'admin',
                avatar: 'JD',
                dateAdded: '2024-01-15',
                lastActive: '2024-10-19'
            },
            {
                id: 2,
                name: 'Sarah Wilson',
                email: 'sarah.wilson@rento.com',
                role: 'manager',
                avatar: 'SW',
                dateAdded: '2024-03-10',
                lastActive: '2024-10-18'
            },
            {
                id: 3,
                name: 'Mike Johnson',
                email: 'mike.johnson@rento.com',
                role: 'assistant',
                avatar: 'MJ',
                dateAdded: '2024-05-20',
                lastActive: '2024-10-17'
            },
            {
                id: 4,
                name: 'Lisa Brown',
                email: 'lisa.brown@rento.com',
                role: 'viewer',
                avatar: 'LB',
                dateAdded: '2024-07-08',
                lastActive: '2024-10-16'
            }
        ];

        document.addEventListener('DOMContentLoaded', function() {
            currentUser = AuthManager.getCurrentUser() || {
                email: 'test@propertymanager.com',
                name: 'Property Manager',
                role: 'property_manager'
            };

            // Update user initials
            if (currentUser.name) {
                const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
                document.getElementById('userInitials').textContent = initials;
            }

            loadPropertyData();
            renderUsers();

            // Form submission
            document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
        });

        function loadPropertyData() {
            const urlParams = new URLSearchParams(window.location.search);
            const propertyId = urlParams.get('id') || localStorage.getItem('selectedPropertyId');
            
            if (!propertyId) {
                window.location.href = 'property-dashboard.html';
                return;
            }

            // Update back button
            document.getElementById('backBtn').href = `property-dashboard.html?id=${propertyId}`;
        }

        function renderUsers() {
            const grid = document.getElementById('usersGrid');
            grid.innerHTML = users.map(user => `
                <div class="user-card">
                    <div class="user-header">
                        <div class="user-avatar">${user.avatar}</div>
                        <div class="user-info">
                            <h3>${user.name}</h3>
                            <div class="user-email">${user.email}</div>
                            <span class="role-badge role-${user.role}">${getRoleDisplayName(user.role)}</span>
                        </div>
                    </div>

                    <div class="permissions-list">
                        <div class="permissions-title">Permissions</div>
                        ${getPermissionsHTML(user.role)}
                    </div>

                    <div class="user-actions">
                        <button class="action-btn btn-edit" onclick="editUser(${user.id})">
                            <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                            </svg>
                            Edit
                        </button>
                        <button class="action-btn btn-remove" onclick="removeUser(${user.id})">
                            <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd"/>
                            </svg>
                            Remove
                        </button>
                    </div>

                    <div style="margin-top: 16px; font-size: 0.75rem; color: var(--text-gray);">
                        <div>Added: ${formatDate(user.dateAdded)}</div>
                        <div>Last active: ${formatDate(user.lastActive)}</div>
                    </div>
                </div>
            `).join('');
        }

        function getRoleDisplayName(role) {
            const roleNames = {
                admin: 'Property Admin',
                manager: 'Property Manager',
                assistant: 'Assistant',
                viewer: 'Viewer'
            };
            return roleNames[role] || role;
        }

        function getPermissionsHTML(role) {
            const permissions = {
                admin: [
                    { name: 'Manage all properties', granted: true },
                    { name: 'Financial management', granted: true },
                    { name: 'User & role management', granted: true },
                    { name: 'Generate reports', granted: true }
                ],
                manager: [
                    { name: 'Manage assigned properties', granted: true },
                    { name: 'Tenant management', granted: true },
                    { name: 'Maintenance requests', granted: true },
                    { name: 'Financial management', granted: false }
                ],
                assistant: [
                    { name: 'View property information', granted: true },
                    { name: 'Manage bookings', granted: true },
                    { name: 'Basic tenant communication', granted: true },
                    { name: 'Edit property details', granted: false }
                ],
                viewer: [
                    { name: 'View property information', granted: true },
                    { name: 'View reports', granted: true },
                    { name: 'Edit any information', granted: false },
                    { name: 'Manage users', granted: false }
                ]
            };

            return permissions[role].map(permission => `
                <div class="permission-item">
                    <div class="permission-icon ${permission.granted ? 'permission-granted' : 'permission-denied'}"></div>
                    <span>${permission.name}</span>
                </div>
            `).join('');
        }

        function showAddUserModal() {
            document.getElementById('addUserModal').style.display = 'flex';
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').style.display = 'none';
            document.getElementById('addUserForm').reset();
        }

        function handleAddUser(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                role: document.getElementById('userRole').value
            };

            // Generate avatar initials
            const avatar = formData.name.split(' ').map(n => n[0]).join('').toUpperCase();

            // Add new user
            const newUser = {
                id: users.length + 1,
                name: formData.name,
                email: formData.email,
                role: formData.role,
                avatar: avatar,
                dateAdded: new Date().toISOString().split('T')[0],
                lastActive: new Date().toISOString().split('T')[0]
            };

            users.push(newUser);
            renderUsers();
            closeAddUserModal();
            
            showNotification(`User ${formData.name} added successfully!`, 'success');
        }

        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                showNotification(`Edit functionality for ${user.name} coming soon!`, 'info');
            }
        }

        function removeUser(userId) {
            if (confirm('Are you sure you want to remove this user?')) {
                const userIndex = users.findIndex(u => u.id === userId);
                if (userIndex > -1) {
                    const userName = users[userIndex].name;
                    users.splice(userIndex, 1);
                    renderUsers();
                    showNotification(`User ${userName} removed successfully!`, 'success');
                }
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function toggleDropdown() {
            const dropdown = document.getElementById('dropdownMenu');
            dropdown.classList.toggle('show');
        }

        async function logout() {
            await AuthManager.signOut();
        }

        // Event listeners
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.user-menu')) {
                document.getElementById('dropdownMenu').classList.remove('show');
            }
        });

        document.getElementById('addUserModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAddUserModal();
            }
        });

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'info' ? '#3b82f6' : type === 'error' ? '#ef4444' : '#10b981'};
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 1000;
                font-weight: 500;
                max-width: 400px;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>
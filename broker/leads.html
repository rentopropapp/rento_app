<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leads - Rento</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <style>
        .lead-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .lead-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .lead-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 16px;
        }

        .lead-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .lead-info {
            flex: 1;
        }

        .lead-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .lead-contact {
            color: var(--text-gray);
            font-size: 0.875rem;
        }

        .lead-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-new {
            background: #fef3c7;
            color: #d97706;
        }

        .status-contacted {
            background: #dbeafe;
            color: #2563eb;
        }

        .status-viewing {
            background: #dcfce7;
            color: #16a34a;
        }

        .status-negotiating {
            background: #fde2e8;
            color: #e11d48;
        }

        .lead-requirements {
            margin-bottom: 16px;
        }

        .requirement-title {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .requirement-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            margin-bottom: 12px;
        }

        .requirement-item {
            background: #f8fafc;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.875rem;
            color: var(--text-gray);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .requirement-item svg {
            color: var(--primary-color);
            flex-shrink: 0;
        }

        .lead-actions {
            display: flex;
            gap: 12px;
        }

        .action-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: white;
            color: var(--text-gray);
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #f8fafc;
            color: var(--text-dark);
        }

        .leads-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--text-gray);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .filter-bar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .filter-row {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            color: var(--text-dark);
            font-size: 0.875rem;
        }

        .priority-high {
            border-left: 4px solid #ef4444;
        }

        .priority-medium {
            border-left: 4px solid #f59e0b;
        }

        .priority-low {
            border-left: 4px solid #10b981;
        }

        .lead-time {
            color: var(--text-gray);
            font-size: 0.75rem;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container nav-content">
            <a href="leads.html"><img src="../assets/rento-logo-dark.svg" alt="Rento" class="nav-logo"></a>
            
            <ul class="nav-links">
                <li><a href="listings.html">Listings</a></li>
                <li><a href="wallet.html">Wallet</a></li>
                <li><a href="leads.html" class="active">Leads</a></li>
                <li><a href="profile.html">Profile</a></li>
            </ul>
            
            <div class="user-menu">
                <div style="background: var(--primary-color); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; cursor: pointer;" onclick="toggleDropdown()" id="userInitials">JD</div>
                <div class="dropdown-menu" id="dropdownMenu">
                    <a href="profile.html" class="dropdown-item">Profile</a>
                    <a href="#" class="dropdown-item" onclick="openAccountSwitcher()">Switch Account</a>
                    <a href="#" class="dropdown-item logout-btn" onclick="logout()">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="page-header">
            <h1 class="page-title">Leads</h1>
            <p class="page-subtitle">Manage tenant inquiries and convert them to bookings</p>
        </div>

        <!-- Stats Overview -->
        <div class="leads-stats">
            <div class="stat-card">
                <div class="stat-number">28</div>
                <div class="stat-label">Total Leads</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">8</div>
                <div class="stat-label">New This Week</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">12</div>
                <div class="stat-label">Active</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">65%</div>
                <div class="stat-label">Conversion Rate</div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-row">
                <span style="font-weight: 500; color: var(--text-dark);">Filter by:</span>
                <select class="filter-select" id="statusFilter" onchange="filterLeads()">
                    <option value="all">All Status</option>
                    <option value="new">New</option>
                    <option value="contacted">Contacted</option>
                    <option value="viewing">Viewing Scheduled</option>
                    <option value="negotiating">Negotiating</option>
                </select>
                <select class="filter-select" id="priorityFilter" onchange="filterLeads()">
                    <option value="all">All Priority</option>
                    <option value="high">High Priority</option>
                    <option value="medium">Medium Priority</option>
                    <option value="low">Low Priority</option>
                </select>
                <select class="filter-select" id="propertyTypeFilter" onchange="filterLeads()">
                    <option value="all">All Property Types</option>
                    <option value="apartment">Flat/Apartment</option>
                    <option value="house">Family Home</option>
                    <option value="student">Student Housing</option>
                    <option value="commercial">Commercial</option>
                </select>
            </div>
        </div>

        <!-- Leads List -->
        <div id="leadsList">
            <div class="lead-card" style="padding: 40px; text-align: center;">
                <div class="loading"></div>
                <p style="margin-top: 16px; color: var(--text-gray);">Loading leads...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/auth.js"></script>
    <script>
        let currentUser = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            currentUser = AuthManager.getCurrentUser();
            if (!currentUser) {
                window.location.href = '../auth/login.html';
                return;
            }

            if (currentUser.role !== 'broker') {
                window.location.href = '../auth/login.html';
                return;
            }

            // Update user avatar with profile photo or initials
            updateUserAvatar(currentUser);

            // Load leads
            await loadLeads();
        });

        // Update avatar when user switches accounts (listen for storage changes)
        window.addEventListener('storage', function(e) {
            if (e.key === 'user') {
                const newUser = e.newValue ? JSON.parse(e.newValue) : null;
                if (newUser) {
                    currentUser = newUser;
                    updateUserAvatar(currentUser);
                }
            }
        });

        let allLeads = [];

        async function loadLeads() {
            try {
                allLeads = await DatabaseManager.getLeads();
                displayLeads(allLeads);
                updateLeadsStats(allLeads);
            } catch (error) {
                console.error('Error loading leads:', error);
                
                // Show sample leads for demonstration
                allLeads = getSampleLeads();
                displayLeads(allLeads);
                updateLeadsStats(allLeads);
            }
        }

        function getSampleLeads() {
            // First, get leads from localStorage (from tenant submissions)
            const storedLeads = JSON.parse(localStorage.getItem('brokerLeads') || '[]');
            const tenantLeads = storedLeads.map(lead => ({
                lead_id: lead.lead_id || 'lead_' + Date.now(),
                tenant_name: lead.tenant_name || 'Unknown Tenant',
                email: lead.email || 'No email provided',
                phone_number: lead.phone_number || 'No phone provided',
                property_type_required: lead.property_type_required || 'apartment',
                location_preferred: lead.location_preferred || 'Location not specified',
                price_range_min: lead.price_range_min || 0,
                price_range_max: lead.price_range_max || 1000000,
                additional_requirements: lead.additional_requirements || 'No additional requirements specified',
                created_at: lead.created_at || new Date().toISOString(),
                status: lead.status || 'new'
            }));
            
            // Combine with sample leads
            const sampleLeads = [
                {
                    lead_id: '1',
                    tenant_name: 'Maria Kabuye',
                    email: 'maria.kabuye@email.com',
                    phone_number: '+256 700 123 456',
                    property_type_required: 'apartment',
                    location_preferred: 'Kampala, Muyenga Area',
                    price_range_min: 800000,
                    price_range_max: 1200000,
                    additional_requirements: 'Looking for a modern apartment with good security, parking, and close to International School of Uganda. Prefer furnished or semi-furnished.',
                    created_at: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(), // 2 hours ago
                    status: 'new'
                },
                {
                    lead_id: '2',
                    tenant_name: 'John Ssemwogerere',
                    email: 'j.ssem@gmail.com',
                    phone_number: '+256 772 987 654',
                    property_type_required: 'studio',
                    location_preferred: 'Makerere, Wandegeya',
                    price_range_min: 200000,
                    price_range_max: 350000,
                    additional_requirements: 'Student at Makerere University. Need affordable room close to campus with reliable water and electricity.',
                    created_at: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(), // 1 day ago
                    status: 'contacted'
                },
                {
                    lead_id: '3',
                    tenant_name: 'Agnes Nakato',
                    email: 'aggie.nak@outlook.com',
                    phone_number: '+256 701 654 321',
                    property_type_required: 'apartment',
                    location_preferred: 'Ntinda, Kiwatule',
                    price_range_min: 600000,
                    price_range_max: 900000,
                    additional_requirements: 'Young professional looking for quiet neighborhood. Viewing scheduled for tomorrow at 2 PM.',
                    created_at: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(), // 3 days ago
                    status: 'viewing'
                }
            ];
            
            // Return combined leads (tenant submissions first, then sample leads)
            return [...tenantLeads, ...sampleLeads];
        }

        function displayLeads(leads) {
            const leadsList = document.getElementById('leadsList');
            
            if (leads.length === 0) {
                leadsList.innerHTML = `
                    <div class="lead-card" style="padding: 40px; text-align: center;">
                        <p style="color: var(--text-gray);">No leads found. New leads will appear here when tenants submit search requests.</p>
                    </div>
                `;
                return;
            }

            leadsList.innerHTML = leads.map(lead => {
                const initials = lead.tenant_name.split(' ').map(n => n[0]).join('').toUpperCase();
                const timeAgo = getTimeAgo(lead.created_at);
                const priority = getPriority(lead);
                
                return `
                    <div class="lead-card ${priority}">
                        <div class="lead-header">
                            <div class="lead-avatar">${initials}</div>
                            <div class="lead-info">
                                <div class="lead-name">${lead.tenant_name}</div>
                                <div class="lead-contact">${lead.email} • ${lead.phone_number}</div>
                                <div class="lead-time">${timeAgo}</div>
                            </div>
                            <div class="lead-status ${getStatusClass(lead.status)}">${getStatusLabel(lead.status)}</div>
                        </div>

                        <div class="lead-requirements">
                            <div class="requirement-title">Looking for:</div>
                            <div class="requirement-list">
                                <div class="requirement-item">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-9 9a1 1 0 001.414 1.414L2 12.414V17a1 1 0 001 1h3a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h3a1 1 0 001-1v-4.586l.293.293a1 1 0 001.414-1.414l-9-9z"/>
                                    </svg>
                                    ${getPropertyTypeLabel(lead.property_type_required)}
                                </div>
                                <div class="requirement-item">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                        <path fillRule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clipRule="evenodd"/>
                                    </svg>
                                    ${lead.location_preferred}
                                </div>
                                <div class="requirement-item">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
                                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clipRule="evenodd"/>
                                    </svg>
                                    ${formatCurrency(lead.price_range_min)} - ${formatCurrency(lead.price_range_max)} /month
                                </div>
                            </div>
                            ${lead.additional_requirements ? `
                                <p style="margin: 12px 0 0 0; color: var(--text-gray); font-size: 0.875rem; line-height: 1.4;">
                                    "${lead.additional_requirements}"
                                </p>
                            ` : ''}
                        </div>

                        <div class="lead-actions">
                            <button class="action-btn btn-primary" onclick="contactLead('${lead.lead_id}')">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                                </svg>
                                Contact
                            </button>
                            <button class="action-btn btn-secondary" onclick="showMatches('${lead.lead_id}')">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                    <path fillRule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd"/>
                                </svg>
                                Show Matches
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateLeadsStats(leads) {
            const totalLeads = leads.length;
            const newThisWeek = leads.filter(lead => {
                const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                return new Date(lead.created_at) > weekAgo;
            }).length;
            const activeLeads = leads.filter(lead => lead.status === 'new' || lead.status === 'contacted').length;
            const conversionRate = totalLeads > 0 ? Math.round((leads.filter(lead => lead.status === 'completed').length / totalLeads) * 100) : 0;

            // Update stats if elements exist (keep current hardcoded stats if not)
            const statsElements = [
                { selector: '.stat-card:nth-child(1) .stat-number', value: totalLeads },
                { selector: '.stat-card:nth-child(2) .stat-number', value: newThisWeek },
                { selector: '.stat-card:nth-child(3) .stat-number', value: activeLeads },
                { selector: '.stat-card:nth-child(4) .stat-number', value: `${conversionRate}%` }
            ];

            statsElements.forEach(stat => {
                const element = document.querySelector(stat.selector);
                if (element && totalLeads > 0) {
                    element.textContent = stat.value;
                }
            });
        }

        function getTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffInMinutes = Math.floor((now - date) / (1000 * 60));
            
            if (diffInMinutes < 60) {
                return `${diffInMinutes} minutes ago`;
            } else if (diffInMinutes < 1440) {
                const hours = Math.floor(diffInMinutes / 60);
                return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            } else {
                const days = Math.floor(diffInMinutes / 1440);
                return `${days} day${days > 1 ? 's' : ''} ago`;
            }
        }

        function getPriority(lead) {
            const now = new Date();
            const created = new Date(lead.created_at);
            const hoursOld = (now - created) / (1000 * 60 * 60);
            
            if (hoursOld < 24 && lead.status === 'new') return 'priority-high';
            if (hoursOld < 72) return 'priority-medium';
            return 'priority-low';
        }

        function getStatusClass(status) {
            const statusMap = {
                'new': 'status-new',
                'contacted': 'status-contacted',
                'viewing': 'status-viewing',
                'negotiating': 'status-negotiating',
                'completed': 'status-viewing'
            };
            return statusMap[status] || 'status-new';
        }

        function getStatusLabel(status) {
            const statusMap = {
                'new': 'New',
                'contacted': 'Contacted',
                'viewing': 'Viewing',
                'negotiating': 'Negotiating',
                'completed': 'Completed'
            };
            return statusMap[status] || 'New';
        }

        function getPropertyTypeLabel(type) {
            const typeMap = {
                'apartment': 'Apartment',
                'house': 'House',
                'studio': 'Studio',
                'commercial': 'Commercial',
                'student': 'Student Housing'
            };
            return typeMap[type] || type;
        }

        function filterLeads() {
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const propertyTypeFilter = document.getElementById('propertyTypeFilter').value;

            let filteredLeads = allLeads.filter(lead => {
                const matchesStatus = statusFilter === 'all' || lead.status === statusFilter;
                const matchesPropertyType = propertyTypeFilter === 'all' || lead.property_type_required === propertyTypeFilter;
                
                let matchesPriority = true;
                if (priorityFilter !== 'all') {
                    const leadPriority = getPriority(lead).replace('priority-', '');
                    matchesPriority = leadPriority === priorityFilter;
                }
                
                return matchesStatus && matchesPropertyType && matchesPriority;
            });

            displayLeads(filteredLeads);
        }

        function contactLead(leadId) {
            showNotification(`Contacting lead ${leadId}...`, 'info');
            // Implementation would open contact modal or redirect to messaging
        }

        function scheduleViewing(leadId) {
            showNotification(`Scheduling viewing for lead ${leadId}...`, 'info');
            // Implementation would open scheduling modal
        }

        function showMatches(leadId) {
            showNotification(`Showing property matches for lead ${leadId}...`, 'info');
            // Implementation would show matching properties
        }

        function followUp(leadId) {
            showNotification(`Following up with lead ${leadId}...`, 'info');
            // Implementation would open follow-up modal
        }

        function viewHistory(leadId) {
            showNotification(`Viewing history for lead ${leadId}...`, 'info');
            // Implementation would show interaction history
        }

        function toggleDropdown() {
            const dropdown = document.getElementById('dropdownMenu');
            dropdown.classList.toggle('show');
        }

        async function logout() {
            await AuthManager.signOut();
        }

        // Event listeners
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.user-menu')) {
                document.getElementById('dropdownMenu').classList.remove('show');
            }
        });
    </script>
</body>
</html>
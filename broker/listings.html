<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Listings - Rento</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container nav-content">
            <a href="listings.html"><img src="../assets/rento-logo-dark.svg" alt="Rento" class="nav-logo"></a>
            
            <ul class="nav-links">
                <li><a href="listings.html" class="active">Listings</a></li>
                <li><a href="wallet.html">Wallet</a></li>
                <li><a href="leads.html">Leads</a></li>
                <li><a href="profile.html">Profile</a></li>
            </ul>
            
            <div class="user-menu">
                <img src="../assets/default-avatar.png" alt="Profile" class="user-avatar" id="userAvatar" onclick="toggleDropdown()" style="display: none;">
                <div style="background: var(--primary-color); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; cursor: pointer;" onclick="toggleDropdown()" id="userInitials">JD</div>
                <div class="dropdown-menu" id="dropdownMenu">
                    <a href="profile.html" class="dropdown-item">Profile</a>
                    <a href="#" class="dropdown-item" onclick="switchAccount(event)">Switch Account</a>
                    <a href="#" class="dropdown-item logout-btn" onclick="logout()">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
        <div class="mobile-nav-items">
            <a href="listings.html" class="mobile-nav-item active">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"/>
                </svg>
                Listings
            </a>
            <a href="wallet.html" class="mobile-nav-item">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6z"/>
                </svg>
                Wallet
            </a>
            <a href="leads.html" class="mobile-nav-item">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
                Leads
            </a>
            <a href="profile.html" class="mobile-nav-item">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
                </svg>
                Profile
            </a>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="page-header">
            <h1 class="page-title">My Property Listings</h1>
            <p class="page-subtitle">Manage your properties and track their performance</p>
        </div>

        <!-- Welcome/Empty State -->
        <div id="emptyState" class="dashboard-card" style="display: none;">
            <div style="text-align: center; padding: 60px 20px;">
                <svg style="width: 64px; height: 64px; color: var(--primary-color); margin-bottom: 20px;" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                </svg>
                <h2 style="margin-bottom: 12px; color: var(--text-dark);">Welcome to Rento!</h2>
                <p style="color: var(--text-gray); margin-bottom: 30px;">Start by adding your first property to begin attracting tenants.</p>
                <button class="cta-button" onclick="showAddPropertyModal()">
                    Add Your First Property
                </button>
            </div>
        </div>

        <!-- Properties Grid -->
        <div id="propertiesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 24px;">
            <!-- Properties will be loaded here -->
        </div>

        <!-- Scheduled Viewings -->
        <div class="dashboard-card" style="margin-top: 32px;">
            <div class="card-header">
                <h2 class="card-title">Scheduled Viewings</h2>
                <button class="btn-secondary" onclick="refreshViewings()">Refresh</button>
            </div>
            <div id="scheduledViewings">
                <p style="text-align: center; color: var(--text-gray); padding: 40px 20px;">
                    No scheduled viewings at this time.
                </p>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" onclick="showAddPropertyModal()" title="Add Property">
        <svg fill="currentColor" viewBox="0 0 20 20" width="24">
            <path fillRule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clipRule="evenodd"/>
        </svg>
    </button>

    <!-- Add Property Modal -->
    <div id="addPropertyModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title">Add New Property</h2>
                <button class="modal-close" onclick="closeAddPropertyModal()">&times;</button>
            </div>
            
            <div id="propertyFormStep1" class="property-step">
                <h3 style="margin-bottom: 20px; color: var(--text-dark);">Step 1: Property Type</h3>
                
                <div class="role-selection" style="grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px;">
                    <label class="role-option" style="padding: 16px 12px;">
                        <input type="radio" name="propertyType" value="flat_apartment" required>
                        <div class="role-title" style="font-size: 0.9rem;">Flat/Apartment</div>
                    </label>
                    <label class="role-option" style="padding: 16px 12px;">
                        <input type="radio" name="propertyType" value="student_housing" required>
                        <div class="role-title" style="font-size: 0.9rem;">Student Housing</div>
                    </label>
                    <label class="role-option" style="padding: 16px 12px;">
                        <input type="radio" name="propertyType" value="family_home" required>
                        <div class="role-title" style="font-size: 0.9rem;">Family Home</div>
                    </label>
                    <label class="role-option" style="padding: 16px 12px;">
                        <input type="radio" name="propertyType" value="retail_units" required>
                        <div class="role-title" style="font-size: 0.9rem;">Retail Units</div>
                    </label>
                    <label class="role-option" style="padding: 16px 12px;">
                        <input type="radio" name="propertyType" value="vacation_home" required>
                        <div class="role-title" style="font-size: 0.9rem;">Vacation Home</div>
                    </label>
                    <label class="role-option" style="padding: 16px 12px;">
                        <input type="radio" name="propertyType" value="bungalows" required>
                        <div class="role-title" style="font-size: 0.9rem;">Bungalows</div>
                    </label>
                    <label class="role-option" style="padding: 16px 12px;">
                        <input type="radio" name="propertyType" value="town_house" required>
                        <div class="role-title" style="font-size: 0.9rem;">Town House</div>
                    </label>
                    <label class="role-option" style="padding: 16px 12px;">
                        <input type="radio" name="propertyType" value="mansion" required>
                        <div class="role-title" style="font-size: 0.9rem;">Mansion</div>
                    </label>
                    <label class="role-option" style="padding: 16px 12px;">
                        <input type="radio" name="propertyType" value="office_space" required>
                        <div class="role-title" style="font-size: 0.9rem;">Office Space</div>
                    </label>
                    <label class="role-option" style="padding: 16px 12px;">
                        <input type="radio" name="propertyType" value="airbnb" required>
                        <div class="role-title" style="font-size: 0.9rem;">Airbnb</div>
                    </label>
                    <label class="role-option" style="padding: 16px 12px;">
                        <input type="radio" name="propertyType" value="commercial_building" required>
                        <div class="role-title" style="font-size: 0.9rem;">Commercial Building</div>
                    </label>
                    <label class="role-option" style="padding: 16px 12px;">
                        <input type="radio" name="propertyType" value="party_venue" required>
                        <div class="role-title" style="font-size: 0.9rem;">Party Venue</div>
                    </label>
                    <label class="role-option" style="padding: 16px 12px;">
                        <input type="radio" name="propertyType" value="warehouses" required>
                        <div class="role-title" style="font-size: 0.9rem;">Warehouses</div>
                    </label>
                    <label class="role-option" style="padding: 16px 12px;">
                        <input type="radio" name="propertyType" value="schools" required>
                        <div class="role-title" style="font-size: 0.9rem;">Schools</div>
                    </label>
                    <label class="role-option" style="padding: 16px 12px;">
                        <input type="radio" name="propertyType" value="hospitals" required>
                        <div class="role-title" style="font-size: 0.9rem;">Hospitals</div>
                    </label>
                    <label class="role-option" style="padding: 16px 12px;">
                        <input type="radio" name="propertyType" value="religious" required>
                        <div class="role-title" style="font-size: 0.9rem;">Religious</div>
                    </label>
                </div>
                
                <button class="form-button" onclick="nextStep()" style="margin-top: 20px;">
                    Continue to Details
                </button>
            </div>

            <div id="propertyFormStep2" class="property-step" style="display: none;">
                <h3 style="margin-bottom: 20px; color: var(--text-dark);">Step 2: Property Details</h3>
                
                <form id="propertyDetailsForm">
                    <div class="form-group">
                        <label for="propertyName" class="form-label">Property Name</label>
                        <input type="text" id="propertyName" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label for="propertyLocation" class="form-label">Location</label>
                        <input type="text" id="propertyLocation" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label for="propertyAmenities" class="form-label">Amenities</label>
                        <textarea id="propertyAmenities" class="form-textarea" rows="3" placeholder="WiFi, Parking, Gym, Pool, etc..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="propertyDescription" class="form-label">Description</label>
                        <textarea id="propertyDescription" class="form-textarea" rows="4" placeholder="Describe your property..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="hasViewingFee" style="margin-right: 8px;">
                            Subject to viewing fee
                        </label>
                        <input type="number" id="viewingFee" class="form-input" placeholder="Fee amount" style="margin-top: 8px; display: none;">
                    </div>

                    <div class="form-group">
                        <label for="leaseType" class="form-label">Lease Type</label>
                        <select id="leaseType" class="form-select" required>
                            <option value="">Select type</option>
                            <option value="fixed-term">Fixed-term</option>
                            <option value="flexible">Flexible</option>
                            <option value="month-to-month">Month-to-month</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="propertyPrice" class="form-label">Price</label>
                        <input type="number" id="propertyPrice" class="form-input" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="propertyStatus" class="form-label">Status</label>
                        <select id="propertyStatus" class="form-select" required>
                            <option value="">Select status</option>
                            <option value="for_rent">For Rent</option>
                            <option value="for_sale">For Sale</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button type="button" class="btn-secondary" onclick="prevStep()" style="flex: 1;">
                            Back
                        </button>
                        <button type="button" class="form-button" onclick="nextStep()" style="flex: 1; margin: 0;">
                            Continue to Photos
                        </button>
                    </div>
                </form>
            </div>

            <div id="propertyFormStep3" class="property-step" style="display: none;">
                <h3 style="margin-bottom: 20px; color: var(--text-dark);">Step 3: Property Photos</h3>
                <p style="color: var(--text-gray); margin-bottom: 20px;">Select at least 3 high-quality images to make your property stand out</p>
                
                <div style="border: 2px dashed var(--border-color); border-radius: 12px; padding: 40px; text-align: center; margin-bottom: 20px;">
                    <input type="file" id="propertyPhotos" accept="image/*" multiple style="display: none;">
                    <svg style="width: 48px; height: 48px; color: var(--text-gray); margin-bottom: 16px;" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clipRule="evenodd"/>
                    </svg>
                    <p style="color: var(--text-gray); margin-bottom: 12px;">Drag and drop images here, or</p>
                    <button type="button" class="btn-secondary" onclick="document.getElementById('propertyPhotos').click()">
                        Choose Files
                    </button>
                </div>

                <div id="photoPreview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; margin-bottom: 20px;">
                </div>

                <div style="display: flex; gap: 12px;">
                    <button type="button" class="btn-secondary" onclick="prevStep()" style="flex: 1;">
                        Back
                    </button>
                    <button type="button" class="form-button" onclick="submitProperty()" style="flex: 1; margin: 0;">
                        <span class="button-text">Create Property</span>
                        <span class="loading hidden">Creating...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/account-switcher.js"></script>
    <script>
        let currentUser = null;
        let currentStep = 1;
        let propertyData = {};
        let selectedPhotos = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                currentUser = AuthManager.getCurrentUser();
                if (!currentUser) {
                    window.location.href = '../auth/login.html';
                    return;
                }

                if (currentUser.role !== 'broker') {
                    window.location.href = '../auth/login.html';
                    return;
                }

                // Update user avatar with profile photo or initials
                updateUserAvatar(currentUser);
                
                // Update user initials or show profile photo
                const userInitials = document.getElementById('userInitials');
                const userAvatar = document.getElementById('userAvatar');
                
                if (currentUser.profile_photo_url) {
                    // Show profile photo
                    userAvatar.src = currentUser.profile_photo_url;
                    userAvatar.style.display = 'block';
                    userInitials.style.display = 'none';
                } else if (currentUser.name) {
                    // Show initials
                    const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
                    userInitials.textContent = initials;
                    userInitials.style.display = 'flex';
                    userAvatar.style.display = 'none';
                }

                await loadProperties();
                await loadScheduledViewings();

            } catch (error) {
                console.error('Error initializing broker listings:', error);
                showNotification('Error loading data', 'error');
            }
        });

        // Update avatar when user switches accounts (listen for storage changes)
        window.addEventListener('storage', function(e) {
            if (e.key === 'user') {
                const newUser = e.newValue ? JSON.parse(e.newValue) : null;
                if (newUser) {
                    currentUser = newUser;
                    updateUserAvatar(currentUser);
                }
            }
        });

        async function loadProperties() {
            try {
                const properties = await DatabaseManager.getUserProperties(currentUser.id);
                
                if (properties.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                    document.getElementById('propertiesGrid').style.display = 'none';
                } else {
                    document.getElementById('emptyState').style.display = 'none';
                    displayProperties(properties);
                }

            } catch (error) {
                console.error('Error loading properties:', error);
                // Show empty state on error for now
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('propertiesGrid').style.display = 'none';
            }
        }

        function displayProperties(properties) {
            const grid = document.getElementById('propertiesGrid');
            
            grid.innerHTML = properties.map(property => `
                <div class="property-card">
                    <div class="property-image" style="background-image: url('${property.photos_urls?.[0] || 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=400'}');">
                        <div style="position: absolute; top: 12px; right: 12px; background: var(--primary-color); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                            ${property.status === 'for_rent' ? 'FOR RENT' : 'FOR SALE'}
                        </div>
                    </div>
                    <div class="property-content">
                        <div class="property-title">${property.property_name}</div>
                        <div class="property-location">📍 ${property.location}</div>
                        <div class="property-price">${formatCurrency(property.price)}${property.status === 'for_rent' ? '/month' : ''}</div>
                        
                        <div class="property-features">
                            <span>${property.property_type}</span>
                            <span>${property.lease_type || 'N/A'}</span>
                        </div>
                        
                        <div style="margin: 12px 0; font-size: 14px; color: var(--text-gray);">
                            <div>Created: ${formatDate(property.created_at)}</div>
                            <div>Views: 0 • Inquiries: 0</div>
                        </div>
                        
                        <div class="property-actions">
                            <button class="btn-primary" onclick="editProperty('${property.property_id}')">
                                Edit
                            </button>
                            <button class="btn-secondary" onclick="viewPropertyStats('${property.property_id}')">
                                Stats
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('propertiesGrid').style.display = 'grid';
        }

        async function loadScheduledViewings() {
            try {
                const properties = await DatabaseManager.getUserProperties(currentUser.id);
                const propertyIds = properties.map(p => p.property_id);
                
                if (propertyIds.length === 0) return;

                const bookings = await DatabaseManager.getBookings({
                    status: 'pending'
                });

                const myBookings = bookings.filter(booking => 
                    propertyIds.includes(booking.property_id)
                );

                const container = document.getElementById('scheduledViewings');
                
                if (myBookings.length > 0) {
                    container.innerHTML = myBookings.map(booking => `
                        <div class="property-card" style="margin-bottom: 16px;">
                            <div class="property-content">
                                <div class="property-title">${booking.properties.property_name}</div>
                                <div style="margin: 8px 0;">
                                    <strong>Viewer:</strong> ${booking.users.name}<br>
                                    <strong>Date:</strong> ${formatDate(booking.viewing_date)}<br>
                                    <strong>Contact:</strong> ${booking.users.phone_number}
                                </div>
                                <div class="property-actions">
                                    <button class="btn-primary" onclick="confirmViewing('${booking.booking_id}')">
                                        Confirm
                                    </button>
                                    <button class="btn-secondary" onclick="rescheduleViewing('${booking.booking_id}')">
                                        Reschedule
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <p style="text-align: center; color: var(--text-gray); padding: 40px 20px;">
                            No scheduled viewings at this time.
                        </p>
                    `;
                }

            } catch (error) {
                console.error('Error loading scheduled viewings:', error);
            }
        }

        // Modal and step management
        function showAddPropertyModal() {
            currentStep = 1;
            propertyData = {};
            selectedPhotos = [];
            showStep(1);
            document.getElementById('addPropertyModal').style.display = 'flex';
        }

        function closeAddPropertyModal() {
            document.getElementById('addPropertyModal').style.display = 'none';
            resetForm();
        }

        function showStep(step) {
            // Hide all steps
            document.querySelectorAll('.property-step').forEach(el => el.style.display = 'none');
            // Show current step
            document.getElementById(`propertyFormStep${step}`).style.display = 'block';
            currentStep = step;
        }

        function nextStep() {
            if (currentStep === 1) {
                const selectedType = document.querySelector('input[name="propertyType"]:checked');
                if (!selectedType) {
                    showNotification('Please select a property type', 'error');
                    return;
                }
                propertyData.property_type = selectedType.value;
                showStep(2);
            } else if (currentStep === 2) {
                if (!validateStep2()) return;
                collectStep2Data();
                showStep(3);
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                showStep(currentStep - 1);
            }
        }

        function validateStep2() {
            const requiredFields = ['propertyName', 'propertyLocation', 'propertyPrice', 'leaseType', 'propertyStatus'];
            for (let field of requiredFields) {
                if (!document.getElementById(field).value.trim()) {
                    showNotification('Please fill in all required fields', 'error');
                    return false;
                }
            }
            return true;
        }

        function collectStep2Data() {
            propertyData.property_name = document.getElementById('propertyName').value;
            propertyData.location = document.getElementById('propertyLocation').value;
            propertyData.amenities = document.getElementById('propertyAmenities').value.split(',').map(a => a.trim()).filter(a => a);
            propertyData.description = document.getElementById('propertyDescription').value;
            propertyData.viewing_fee = document.getElementById('hasViewingFee').checked ? 
                parseFloat(document.getElementById('viewingFee').value) : null;
            propertyData.lease_type = document.getElementById('leaseType').value;
            propertyData.price = parseFloat(document.getElementById('propertyPrice').value);
            propertyData.status = document.getElementById('propertyStatus').value;
        }

        async function submitProperty() {
            const button = event.target;
            const buttonText = button.querySelector('.button-text');
            const loading = button.querySelector('.loading');

            if (selectedPhotos.length < 3) {
                showNotification('Please select at least 3 photos', 'error');
                return;
            }

            try {
                button.disabled = true;
                buttonText.classList.add('hidden');
                loading.classList.remove('hidden');

                // Upload photos and get URLs (simplified for demo)
                const photoUrls = selectedPhotos.map((photo, index) => 
                    `https://images.unsplash.com/photo-${1560448204 + index}-e02f11c3d0e2?w=800`
                );
                
                propertyData.photos_urls = photoUrls;
                
                await DatabaseManager.createProperty(propertyData);
                
                showNotification('Property created successfully!', 'success');
                closeAddPropertyModal();
                await loadProperties();

            } catch (error) {
                console.error('Error creating property:', error);
                showNotification('Error creating property. Please try again.', 'error');
            } finally {
                button.disabled = false;
                buttonText.classList.remove('hidden');
                loading.classList.add('hidden');
            }
        }

        // Photo handling
        document.getElementById('propertyPhotos').addEventListener('change', function(e) {
            selectedPhotos = Array.from(e.target.files);
            displayPhotoPreview();
        });

        function displayPhotoPreview() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = selectedPhotos.map((photo, index) => `
                <div style="position: relative; border-radius: 8px; overflow: hidden; aspect-ratio: 1;">
                    <img src="${URL.createObjectURL(photo)}" style="width: 100%; height: 100%; object-fit: cover;">
                    <button onclick="removePhoto(${index})" style="position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;">×</button>
                </div>
            `).join('');
        }

        function removePhoto(index) {
            selectedPhotos.splice(index, 1);
            displayPhotoPreview();
        }

        // Viewing fee checkbox handling
        document.getElementById('hasViewingFee').addEventListener('change', function() {
            const feeInput = document.getElementById('viewingFee');
            feeInput.style.display = this.checked ? 'block' : 'none';
            if (!this.checked) feeInput.value = '';
        });

        // Property type selection handling
        document.querySelectorAll('input[name="propertyType"]').forEach(input => {
            input.addEventListener('change', function() {
                document.querySelectorAll('.role-option').forEach(opt => opt.classList.remove('selected'));
                this.closest('.role-option').classList.add('selected');
            });
        });

        function resetForm() {
            document.querySelectorAll('.role-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById('propertyDetailsForm').reset();
            document.getElementById('propertyPhotos').value = '';
            document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('viewingFee').style.display = 'none';
            selectedPhotos = [];
            propertyData = {};
        }

        function editProperty(propertyId) {
            showNotification('Edit property feature coming soon!', 'info');
        }

        function viewPropertyStats(propertyId) {
            showNotification('Property statistics feature coming soon!', 'info');
        }

        async function confirmViewing(bookingId) {
            try {
                await supabase
                    .from('bookings')
                    .update({ status: 'confirmed' })
                    .eq('booking_id', bookingId);

                showNotification('Viewing confirmed successfully!', 'success');
                await loadScheduledViewings();
            } catch (error) {
                console.error('Error confirming viewing:', error);
                showNotification('Error confirming viewing', 'error');
            }
        }

        function rescheduleViewing(bookingId) {
            showNotification('Reschedule feature coming soon!', 'info');
        }

        function refreshViewings() {
            loadScheduledViewings();
            showNotification('Viewings refreshed', 'info');
        }

        function toggleDropdown() {
            const dropdown = document.getElementById('dropdownMenu');
            dropdown.classList.toggle('show');
        }

        async function logout() {
            await AuthManager.signOut();
        }

        function openAccountSwitcher() {
            if (window.accountSwitcher) {
                window.accountSwitcher.openModal();
            }
        }

        // Event listeners
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.user-menu')) {
                document.getElementById('dropdownMenu').classList.remove('show');
            }
        });

        document.getElementById('addPropertyModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAddPropertyModal();
            }
        });
    </script>
</body>
</html>